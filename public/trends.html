<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rayo Vilkins - Performance Trends</title>
<style>
  :root{
    --bg:#0f0f0f; --card:#1a1a1a; --text:#ffffff; --muted:#a1a1aa; --line:#333333;
    --rail:#facc15; --rail-dark:#f59e0b; --active-bg:#1e40af; --active-br:#3b82f6; --active-tx:#ffffff;
    --score:#ffffff; --win:#22c55e; --loss:#ef4444; --draw:#f59e0b;
    --navy:#ffffff; --pitch:#1a2e1a;
    --match-bg:#1f1f1f; --match-hover:#2a2a2a; --ft-bg:#333333;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body::after{content:"";display:block;height:120px}

  /* Header / Nav */
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line)}
  .bar{max-width:1500px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 14px}
  .brand{font-weight:800;letter-spacing:.2px;font-size:14px;opacity:.9;color:var(--text)}
  .brand a{color:inherit;text-decoration:none}
  nav{display:flex;gap:6px}
  nav a{color:var(--muted);text-decoration:none;font-size:13px;padding:6px 10px;border-radius:8px;border:1px solid transparent}
  nav a[aria-current="page"]{background:var(--active-bg);border-color:var(--active-br);color:var(--active-tx)}
  nav a:hover{color:var(--text)}
  .spacer{flex:1}

  /* Page Layout */
  .wrap{max-width:1400px;margin:16px auto;padding:0 12px}
  .page-header{text-align:center;margin-bottom:24px}
  .page-title{font-size:28px;font-weight:800;color:var(--text);margin-bottom:8px}
  .page-subtitle{color:var(--muted);font-size:14px}

  /* Grid Layout */
  .trends-grid{display:grid;grid-template-columns:1fr;gap:20px}
  .section-card{background:var(--card);border-radius:12px;padding:20px;border:1px solid var(--line)}
  .section-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}
  .section-subtitle{font-size:12px;color:var(--muted);margin-bottom:12px}

  /* Chart Controls */
  .chart-controls{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px;padding:16px;background:var(--match-bg);border-radius:8px;border:1px solid var(--line)}
  .control-group{display:flex;flex-direction:column;gap:6px}
  .control-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
  .checkbox-group{display:flex;flex-wrap:wrap;gap:8px}
  .checkbox-item{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg);border:1px solid var(--line);border-radius:6px;cursor:pointer;transition:all .2s;user-select:none}
  .checkbox-item:hover{border-color:var(--active-br)}
  .checkbox-item.active{background:var(--active-bg);color:var(--active-tx);border-color:var(--active-br)}
  .checkbox-item input{display:none}
  .stat-color{width:12px;height:12px;border-radius:2px;margin-right:4px}

  /* Match Count Input */
  .match-count-input{background:var(--bg);color:var(--text);border:1px solid var(--line);border-radius:6px;padding:6px 10px;width:80px}
  .match-count-controls{display:flex;gap:8px;align-items:center}

  /* Chart Container */
  .chart-container{position:relative;height:400px;background:var(--match-bg);border-radius:8px;padding:16px}
  .chart-canvas{width:100% !important;height:100% !important}

  /* Form Strip */
  .form-strip{display:flex;justify-content:center;gap:4px;margin-bottom:16px}
  .form-match{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;border:2px solid var(--line)}
  .form-match.win{background:var(--win);color:#fff;border-color:var(--win)}
  .form-match.loss{background:var(--loss);color:#fff;border-color:var(--loss)}
  .form-match.draw{background:var(--draw);color:#111827;border-color:var(--draw)}

  /* Stats Grid */
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
  .stat-item{background:var(--match-bg);padding:16px;border-radius:8px;border:1px solid var(--line);text-align:center}
  .stat-value{font-size:24px;font-weight:800;color:var(--text);margin-bottom:4px}
  .stat-value.positive{color:var(--win)}
  .stat-value.negative{color:var(--loss)}
  .stat-value.neutral{color:var(--draw)}
  .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .stat-trend{font-size:11px;color:var(--muted);margin-top:4px}

  /* Enhanced Correlation Matrix */
  .correlation-matrix{display:grid;grid-template-columns:140px repeat(4,1fr);gap:2px;background:var(--line);border-radius:8px;overflow:hidden;margin-bottom:16px}
  .matrix-cell{background:var(--match-bg);padding:12px 8px;text-align:center;font-size:12px;font-weight:500}
  .matrix-header{background:var(--bg);font-weight:600;color:var(--text);font-size:11px}
  .matrix-value{font-weight:600}
  .correlation-high{background:var(--win);color:#fff}
  .correlation-medium{background:var(--draw);color:#111827}
  .correlation-low{background:var(--loss);color:#fff}
  .correlation-neutral{background:var(--muted);color:#fff}

  /* Correlation Legend */
  .correlation-legend{display:flex;justify-content:center;gap:16px;margin-bottom:12px;font-size:11px}
  .legend-item{display:flex;align-items:center;gap:4px}
  .legend-color{width:12px;height:12px;border-radius:2px}

  /* Tactical Insights */
  .insights-list{display:flex;flex-direction:column;gap:12px}
  .insight-item{background:var(--match-bg);padding:16px;border-radius:8px;border-left:4px solid var(--rail)}
  .insight-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:6px}
  .insight-description{font-size:12px;color:var(--muted);line-height:1.4}
  .insight-impact{font-size:11px;color:var(--rail);margin-top:4px;font-weight:500}

  /* Consistency Indicators */
  .consistency-bars{display:flex;flex-direction:column;gap:12px}
  .consistency-bar{background:var(--match-bg);padding:12px;border-radius:8px;border:1px solid var(--line)}
  .consistency-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .consistency-name{font-size:13px;color:var(--text);font-weight:500}
  .consistency-score{font-size:12px;color:var(--muted)}
  .consistency-track{height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
  .consistency-fill{height:100%;border-radius:3px;transition:width .3s}

  /* Loading State */
  .loading{display:flex;align-items:center;justify-content:center;height:200px;color:var(--muted);font-style:italic}

  /* Responsive */
  @media (max-width: 1200px) {
    .trends-grid{grid-template-columns:1fr}
  }
  @media (max-width: 768px) {
    .wrap{padding:0 8px}
    .chart-controls{flex-direction:column}
    .checkbox-group{justify-content:center}
    .stats-grid{grid-template-columns:repeat(2,1fr)}
    .correlation-matrix{grid-template-columns:100px repeat(4,1fr);font-size:10px}
    .matrix-cell{padding:6px 3px}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><a href="matches.html">Rayo Vilkins FC</a></div>
      <div class="spacer"></div>
      <nav>
        <a href="matches.html">Matches</a>
        <a href="stats.html">Stats</a>
        <a href="trends.html" aria-current="page">Trends</a>
        <a href="wheel.html">Wheel</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <div class="page-header">
      <h1 class="page-title">Performance Trends & Insights</h1>
      <p class="page-subtitle">Deep analysis of your team's performance patterns over time</p>
    </div>

    <div class="trends-grid">
      <!-- Performance Trends Chart -->
      <div class="section-card">
        <h2 class="section-title">📈 Performance Efficiency Trends</h2>
        <p class="section-subtitle">Track key performance metrics over your match sequence</p>
        
        <div class="chart-controls">
          <div class="control-group">
            <label class="control-label">Metrics to Display</label>
            <div class="checkbox-group" id="metricControls">
              <div class="checkbox-item active" data-metric="passSuccess">
                <div class="stat-color" style="background:#8b5cf6"></div>
                Pass Success %
              </div>
              <div class="checkbox-item active" data-metric="tackleSuccess">
                <div class="stat-color" style="background:#06b6d4"></div>
                Tackle Success %
              </div>
              <div class="checkbox-item active" data-metric="shotSuccess">
                <div class="stat-color" style="background:#f97316"></div>
                Shot Success %
              </div>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label">Match Count</label>
            <div class="match-count-controls">
              <input type="number" id="matchCountInput" class="match-count-input" value="20" min="5" max="999">
              <button id="showAllMatches" style="background:var(--bg);color:var(--text);border:1px solid var(--line);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px">Show All</button>
            </div>
          </div>
        </div>
        
        <div class="chart-container">
          <canvas id="trendsChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Current Form & Key Stats -->
      <div class="section-card">
        <h2 class="section-title">🔥 Current Form & Key Metrics</h2>
        <p class="section-subtitle">Recent performance and season averages</p>
        
        <div id="formStrip" class="form-strip">
          <div class="loading">Loading recent form...</div>
        </div>
        
        <div id="keyStats" class="stats-grid">
          <div class="loading">Loading statistics...</div>
        </div>
      </div>

      <!-- Enhanced Performance Correlation Matrix -->
      <div class="section-card">
        <h2 class="section-title">🎯 Performance Correlation Analysis</h2>
        <p class="section-subtitle">How different metrics relate to each other and match outcomes</p>
        
        <div class="correlation-legend">
          <div class="legend-item">
            <div class="legend-color correlation-high"></div>
            <span>Strong (70%+)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color correlation-medium"></div>
            <span>Moderate (40-69%)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color correlation-low"></div>
            <span>Weak (0-39%)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color correlation-neutral"></div>
            <span>Negative</span>
          </div>
        </div>
        
        <div id="correlationMatrix" class="correlation-matrix">
          <div class="loading" style="grid-column:span 7;">Calculating correlations...</div>
        </div>
      </div>

      <!-- Consistency Tracker -->
      <div class="section-card">
        <h2 class="section-title">📊 Performance Consistency</h2>
        <p class="section-subtitle">How reliable and predictable each performance metric is</p>
        
        <div id="consistencyBars" class="consistency-bars">
          <div class="loading">Analyzing consistency patterns...</div>
        </div>
      </div>

      <!-- Enhanced Tactical Insights -->
      <div class="section-card">
        <h2 class="section-title">🧠 Tactical Insights</h2>
        <p class="section-subtitle">Data-driven observations about your team's patterns and opportunities</p>
        
        <div id="tacticalInsights" class="insights-list">
          <div class="loading">Generating insights...</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const OUR_CLUB_ID = '63719';
  const API_BASE = '';
  
  let allMatchesData = [];
  let displayedMatchesData = [];
  let trendsChart = null;
  
  // Chart colors - distinct from result colors
  const COLORS = {
    passSuccess: '#8b5cf6', 
    tackleSuccess: '#06b6d4',
    shotSuccess: '#f97316'
  };
  
  const RESULT_COLORS = {
    'W': '#22c55e',
    'D': '#fbbf24', 
    'L': '#ef4444'
  };

  async function getJSON(path){
    const res = await fetch(`${API_BASE}${path}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function processMatchData(matches) {
    return matches.map((match, index) => {
      // Calculate efficiency metrics
      const passSuccess = match.our_passes_made && match.our_pass_attempts ?
        (parseInt(match.our_passes_made) / parseInt(match.our_pass_attempts)) * 100 : 0;
        
      const tackleSuccess = match.our_tackles_made && match.our_tackle_attempts ?
        (parseInt(match.our_tackles_made) / parseInt(match.our_tackle_attempts)) * 100 : 0;
      
      const shotSuccess = match.our_goals && match.our_shots ? 
        (parseInt(match.our_goals) / parseInt(match.our_shots)) * 100 : 0;
        
      // Result points: Win = 100%, Draw = 50%, Loss = 0%
      const resultPoints = match.result === 'W' ? 100 : (match.result === 'D' ? 50 : 0);
      
      const goalsScored = parseInt(match.our_goals) || 0;
      const goalsConceded = parseInt(match.opponent_goals) || 0;
      
      return {
        matchNumber: index + 1,
        opponent: match.opponent_club_name,
        date: match.match_date,
        result: match.result,
        passSuccess, 
        tackleSuccess,
        shotSuccess,
        resultPoints,
        goalsScored,
        goalsConceded,
        ourGoals: goalsScored,
        oppGoals: goalsConceded,
        // Add flag for invalid matches (disconnects)
        isValid: !(passSuccess === 100 && (goalsScored + goalsConceded) <= 3)
      };
    }).filter(match => match.isValid); // Filter out invalid matches
  }

  function updateDisplayedMatches() {
    const matchCount = parseInt(document.getElementById('matchCountInput').value);
    const totalMatches = allMatchesData.length;
    
    if (matchCount >= totalMatches) {
      displayedMatchesData = [...allMatchesData];
    } else {
      displayedMatchesData = allMatchesData.slice(-matchCount);
    }
    
    if (displayedMatchesData.length > 0) {
      createTrendsChart(displayedMatchesData);
      renderFormStrip(displayedMatchesData);
      renderKeyStats(displayedMatchesData);
      renderConsistencyBars(displayedMatchesData);
      renderTacticalInsights(displayedMatchesData);
    }
  }

  function createTrendsChart(data) {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    const datasets = [];
    
    // Create datasets for each active metric with result-colored dots
    ['passSuccess', 'tackleSuccess', 'shotSuccess'].forEach(metric => {
      const checkbox = document.querySelector(`[data-metric="${metric}"]`);
      if (checkbox && checkbox.classList.contains('active')) {
        // Create point colors array based on match results
        const pointColors = data.map(d => RESULT_COLORS[d.result]);
        const pointBorderColors = data.map(d => RESULT_COLORS[d.result]);
        
        datasets.push({
          label: getMetricLabel(metric),
          data: data.map(d => d[metric]),
          borderColor: COLORS[metric],
          backgroundColor: COLORS[metric] + '20',
          borderWidth: 2,
          fill: false,
          tension: 0.4,
          pointBackgroundColor: pointColors,
          pointBorderColor: pointBorderColors,
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        });
      }
    });

    if (trendsChart) {
      trendsChart.destroy();
    }
    
    trendsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => `Match ${d.matchNumber}`),
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#ffffff',
              usePointStyle: true,
              padding: 20,
              generateLabels: function(chart) {
                const original = Chart.defaults.plugins.legend.labels.generateLabels;
                const labels = original.call(this, chart);
                
                // Add result color legend
                labels.push(
                  { text: 'Win', fillStyle: '#22c55e', strokeStyle: '#22c55e', pointStyle: 'circle' },
                  { text: 'Draw', fillStyle: '#f59e0b', strokeStyle: '#f59e0b', pointStyle: 'circle' },
                  { text: 'Loss', fillStyle: '#ef4444', strokeStyle: '#ef4444', pointStyle: 'circle' }
                );
                return labels;
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: '#1a1a1a',
            titleColor: '#ffffff',
            bodyColor: '#a1a1aa',
            borderColor: '#333333',
            borderWidth: 1,
            callbacks: {
              title: function(context) {
                const match = data[context[0].dataIndex];
                return `vs ${match.opponent} (${match.date})`;
              },
              afterTitle: function(context) {
                const match = data[context[0].dataIndex];
                return `Result: ${match.ourGoals}-${match.oppGoals} (${match.result})`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: '#333333'
            },
            ticks: {
              color: '#a1a1aa'
            }
          },
          y: {
            grid: {
              color: '#333333'
            },
            ticks: {
              color: '#a1a1aa',
              callback: function(value) {
                return value.toFixed(0) + '%';
              }
            },
            min: 0,
            max: 100,
            beginAtZero: true,
            suggestedMax: 100
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
  }

  function getMetricLabel(metric) {
    const labels = {
      passSuccess: 'Pass Success %',
      tackleSuccess: 'Tackle Success %', 
      shotSuccess: 'Shot Success %'
    };
    return labels[metric] || metric;
  }

  function renderFormStrip(data) {
    const recent = data.slice(-10);
    const container = document.getElementById('formStrip');
    
    container.innerHTML = recent.map(match => 
      `<div class="form-match ${match.result.toLowerCase()}" title="vs ${match.opponent}: ${match.ourGoals}-${match.oppGoals}">
        ${match.result}
      </div>`
    ).join('');
  }

  function renderKeyStats(data) {
    const container = document.getElementById('keyStats');
    
    if (data.length === 0) {
      container.innerHTML = '<div class="loading">No match data available</div>';
      return;
    }
    
    // Calculate averages and trends
    const avgPasses = data.reduce((sum, m) => sum + (m.passSuccess || 0), 0) / data.length;
    const avgTackles = data.reduce((sum, m) => sum + (m.tackleSuccess || 0), 0) / data.length;
    const avgShots = data.reduce((sum, m) => sum + (m.shotSuccess || 0), 0) / data.length;
    const winRate = (data.filter(m => m.result === 'W').length / data.length) * 100;
    const avgGoalsFor = data.reduce((sum, m) => sum + (m.goalsScored || 0), 0) / data.length;
    const avgGoalsAgainst = data.reduce((sum, m) => sum + (m.goalsConceded || 0), 0) / data.length;
    
    // Recent form vs overall
    const recent5 = data.slice(-5);
    const recent5WinRate = recent5.length > 0 ? (recent5.filter(m => m.result === 'W').length / recent5.length) * 100 : 0;
    const formTrend = recent5WinRate > winRate ? 'positive' : (recent5WinRate < winRate ? 'negative' : 'neutral');
    
    const currentStreak = calculateCurrentStreak(data);
    
    container.innerHTML = `
      <div class="stat-item">
        <div class="stat-value">${avgPasses.toFixed(1)}%</div>
        <div class="stat-label">Pass Success</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgTackles.toFixed(1)}%</div>
        <div class="stat-label">Tackle Success</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgShots.toFixed(1)}%</div>
        <div class="stat-label">Shot Success</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgGoalsFor.toFixed(1)}</div>
        <div class="stat-label">Goals Per Game</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgGoalsAgainst.toFixed(1)}</div>
        <div class="stat-label">Goals Against</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${winRate.toFixed(1)}%</div>
        <div class="stat-label">Win Rate</div>
        <div class="stat-trend">Overall</div>
      </div>
      <div class="stat-item">
        <div class="stat-value ${formTrend}">${recent5WinRate.toFixed(1)}%</div>
        <div class="stat-label">Recent Form</div>
        <div class="stat-trend">Last ${recent5.length} matches</div>
      </div>
      <div class="stat-item">
        <div class="stat-value ${currentStreak.type}">${currentStreak.count}</div>
        <div class="stat-label">Current Streak</div>
        <div class="stat-trend">${currentStreak.text}</div>
      </div>
    `;
  }

  function calculateCurrentStreak(data) {
    if (data.length === 0) return { count: 0, type: 'neutral', text: 'No matches' };
    
    const lastResult = data[data.length - 1].result;
    let count = 1;
    
    for (let i = data.length - 2; i >= 0; i--) {
      if (data[i].result === lastResult) {
        count++;
      } else {
        break;
      }
    }
    
    const type = lastResult === 'W' ? 'positive' : (lastResult === 'L' ? 'negative' : 'neutral');
    const text = lastResult === 'W' ? 'Win streak' : (lastResult === 'L' ? 'Loss streak' : 'Draw streak');
    
    return { count, type, text };
  }

  function renderCorrelationMatrix(data) {
    const container = document.getElementById('correlationMatrix');
    
    if (data.length < 5) {
      container.innerHTML = '<div class="loading" style="grid-column:span 5;">Need at least 5 matches for meaningful correlation analysis</div>';
      return;
    }
    
    // Calculate correlations between each metric and match wins/results
    const metrics = [
      { key: 'passSuccess', label: 'Pass Success %' },
      { key: 'tackleSuccess', label: 'Tackle Success %' },
      { key: 'shotSuccess', label: 'Shot Success %' },
      { key: 'resultPoints', label: 'Match Result' }
    ];
    
    // Calculate win correlation for each metric
    const wins = data.map(d => d.result === 'W' ? 1 : 0);
    const correlations = {};
    
    metrics.forEach(metric => {
      const values = data.map(d => d[metric.key] || 0);
      correlations[metric.key] = calculateCorrelation(wins, values);
    });
    
    // Also calculate metric inter-correlations
    const interCorrelations = {};
    metrics.forEach(metric1 => {
      interCorrelations[metric1.key] = {};
      metrics.forEach(metric2 => {
        const values1 = data.map(d => d[metric1.key] || 0);
        const values2 = data.map(d => d[metric2.key] || 0);
        interCorrelations[metric1.key][metric2.key] = calculateCorrelation(values1, values2);
      });
    });
    
    container.innerHTML = `
      <div class="matrix-cell matrix-header">Metric</div>
      <div class="matrix-cell matrix-header">Pass %</div>
      <div class="matrix-cell matrix-header">Tackle %</div>
      <div class="matrix-cell matrix-header">Shot %</div>
      <div class="matrix-cell matrix-header">Win Rate</div>
      
      <div class="matrix-cell matrix-header">Pass Success %</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(1.0)}">100%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(interCorrelations.passSuccess.tackleSuccess)}">${(interCorrelations.passSuccess.tackleSuccess * 100).toFixed(0)}%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(interCorrelations.passSuccess.shotSuccess)}">${(interCorrelations.passSuccess.shotSuccess * 100).toFixed(0)}%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(correlations.passSuccess)}">${(correlations.passSuccess * 100).toFixed(0)}%</div>
      
      <div class="matrix-cell matrix-header">Tackle Success %</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(interCorrelations.tackleSuccess.passSuccess)}">${(interCorrelations.tackleSuccess.passSuccess * 100).toFixed(0)}%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(1.0)}">100%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(interCorrelations.tackleSuccess.shotSuccess)}">${(interCorrelations.tackleSuccess.shotSuccess * 100).toFixed(0)}%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(correlations.tackleSuccess)}">${(correlations.tackleSuccess * 100).toFixed(0)}%</div>
      
      <div class="matrix-cell matrix-header">Shot Success %</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(interCorrelations.shotSuccess.passSuccess)}">${(interCorrelations.shotSuccess.passSuccess * 100).toFixed(0)}%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(interCorrelations.shotSuccess.tackleSuccess)}">${(interCorrelations.shotSuccess.tackleSuccess * 100).toFixed(0)}%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(1.0)}">100%</div>
      <div class="matrix-cell matrix-value ${getCorrelationClass(correlations.shotSuccess)}">${(correlations.shotSuccess * 100).toFixed(0)}%</div>
    `;
  }

  function calculateCorrelation(x, y) {
    const n = x.length;
    if (n === 0 || n < 2) return 0;
    
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
    const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
    
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    
    if (denominator === 0 || isNaN(denominator)) return 0;
    const correlation = numerator / denominator;
    
    return isNaN(correlation) ? 0 : correlation;
  }

  function getCorrelationClass(correlation) {
    const abs = Math.abs(correlation);
    if (correlation < -0.1) return 'correlation-neutral';
    if (abs >= 0.7) return 'correlation-high';
    if (abs >= 0.4) return 'correlation-medium';
    return 'correlation-low';
  }

  function renderConsistencyBars(data) {
    const container = document.getElementById('consistencyBars');
    
    if (data.length < 2) {
      container.innerHTML = '<div class="loading">Need at least 2 matches to calculate consistency</div>';
      return;
    }
    
    const metrics = [
      { key: 'passSuccess', name: 'Pass Success Rate', color: '#3b82f6' },
      { key: 'tackleSuccess', name: 'Tackle Success Rate', color: '#f59e0b' },
      { key: 'goalsScored', name: 'Goals Scored', color: '#ef4444' },
      { key: 'goalsConceded', name: 'Goals Conceded', color: '#8b5cf6' },
      { key: 'resultPoints', name: 'Match Results', color: '#22c55e' }
    ];
    
    container.innerHTML = metrics.map(metric => {
      const values = data.map(d => d[metric] || 0);
      const consistency = calculateConsistency(values);
      
      return `
        <div class="consistency-bar">
          <div class="consistency-label">
            <span class="consistency-name">${metric.name}</span>
            <span class="consistency-score">${consistency.toFixed(1)}% consistent</span>
          </div>
          <div class="consistency-track">
            <div class="consistency-fill" style="width:${consistency}%;background:${metric.color}"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function calculateConsistency(values) {
    if (values.length < 3) return 0;
    
    // Filter out invalid values (NaN, Infinity, null, undefined)
    const validValues = values.filter(v => 
      typeof v === 'number' && 
      !isNaN(v) && 
      isFinite(v) && 
      v >= 0
    );
    
    if (validValues.length < 3) return 0;
    
    const mean = validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
    
    // Handle edge case where all values are the same
    if (validValues.every(v => v === validValues[0])) return 100;
    
    const variance = validValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (validValues.length - 1);
    const stdDev = Math.sqrt(variance);
    
    // Calculate coefficient of variation (CV)
    const coefficientOfVariation = mean > 0 ? stdDev / mean : 1;
    
    // Convert to consistency percentage - lower CV means higher consistency
    // Cap CV at 1.0 for reasonable scaling
    const cappedCV = Math.min(coefficientOfVariation, 1.0);
    const consistency = (1 - cappedCV) * 100;
    
    return Math.max(0, Math.min(100, consistency));
  }

  function renderTacticalInsights(data) {
    const container = document.getElementById('tacticalInsights');
    const insights = generateInsights(data);
    
    container.innerHTML = insights.map(insight => `
      <div class="insight-item">
        <div class="insight-title">${insight.title}</div>
        <div class="insight-description">${insight.description}</div>
        <div class="insight-impact">Impact: ${insight.impact}</div>
      </div>
    `).join('');
  }

  function generateInsights(data) {
    if (data.length < 3) {
      return [{
        title: 'More Data Needed',
        description: 'Play more matches to unlock deeper tactical insights and patterns.',
        impact: 'Keep building your match history for better analysis'
      }];
    }
    
    const insights = [];
    
    const wins = data.filter(d => d.result === 'W');
    const losses = data.filter(d => d.result === 'L');
    const draws = data.filter(d => d.result === 'D');
    
    // EFFICIENCY ANALYSIS
    const avgShotsInWins = wins.length > 0 ? wins.reduce((sum, m) => sum + (m.shotSuccess || 0), 0) / wins.length : 0;
    const avgShotsInLosses = losses.length > 0 ? losses.reduce((sum, m) => sum + (m.shotSuccess || 0), 0) / losses.length : 0;
    
    if (wins.length > 0 && losses.length > 0 && avgShotsInWins > avgShotsInLosses + 8) {
      insights.push({
        title: '🎯 Clinical Finishing Wins Games',
        description: `Your shot conversion is ${(avgShotsInWins - avgShotsInLosses).toFixed(1)}% higher in victories. When your strikers are clinical, you win more consistently.`,
        impact: 'High - Focus on finishing drills and composure in front of goal'
      });
    }
    
    // DEFENSIVE SOLIDITY
    const avgConcededInWins = wins.length > 0 ? wins.reduce((sum, m) => sum + m.goalsConceded, 0) / wins.length : 0;
    const avgConcededInLosses = losses.length > 0 ? losses.reduce((sum, m) => sum + m.goalsConceded, 0) / losses.length : 0;
    
    if (wins.length > 0 && losses.length > 0 && avgConcededInLosses > avgConcededInWins + 1.2) {
      insights.push({
        title: '🛡️ Defense Wins Championships',
        description: `You concede ${(avgConcededInLosses - avgConcededInWins).toFixed(1)} more goals per game in losses. Defensive stability is your foundation for success.`,
        impact: 'Critical - Prioritize defensive organization and communication'
      });
    }
    
    // POSSESSION CONTROL
    const avgPassInWins = wins.length > 0 ? wins.reduce((sum, m) => sum + (m.passSuccess || 0), 0) / wins.length : 0;
    const avgPassInLosses = losses.length > 0 ? losses.reduce((sum, m) => sum + (m.passSuccess || 0), 0) / losses.length : 0;
    
    if (wins.length > 0 && losses.length > 0 && avgPassInWins > avgPassInLosses + 12) {
      insights.push({
        title: '⚽ Possession = Control',
        description: `Pass accuracy is ${(avgPassInWins - avgPassInLosses).toFixed(1)}% higher in wins. Better ball retention leads to dictating game tempo.`,
        impact: 'High - Work on technical skills and patient build-up play'
      });
    }
    
    // PRESSING SUCCESS
    const avgTackleInWins = wins.length > 0 ? wins.reduce((sum, m) => sum + (m.tackleSuccess || 0), 0) / wins.length : 0;
    const avgTackleInLosses = losses.length > 0 ? losses.reduce((sum, m) => sum + (m.tackleSuccess || 0), 0) / losses.length : 0;
    
    if (wins.length > 0 && losses.length > 0 && avgTackleInWins > avgTackleInLosses + 18) {
      insights.push({
        title: '🔥 High Press Advantage',
        description: `Tackle success is ${(avgTackleInWins - avgTackleInLosses).toFixed(1)}% higher in wins. Aggressive pressing disrupts opponents' rhythm.`,
        impact: 'Medium - Implement coordinated pressing triggers and transitions'
      });
    }
    
    // MOMENTUM & FORM ANALYSIS
    const recent5 = data.slice(-5);
    const recent5Wins = recent5.filter(m => m.result === 'W').length;
    const recent5Goals = recent5.reduce((sum, m) => sum + m.goalsScored, 0);
    const recent5Conceded = recent5.reduce((sum, m) => sum + m.goalsConceded, 0);
    
    if (recent5Wins >= 4) {
      insights.push({
        title: '📈 Peak Performance Phase',
        description: `${recent5Wins} wins in last 5 matches with +${(recent5Goals - recent5Conceded)} goal difference. Team chemistry and tactical understanding are peaking.`,
        impact: 'Positive - Maintain current formation and squad selection'
      });
    } else if (recent5Wins <= 1) {
      insights.push({
        title: '⚠️ Form Crisis Brewing',
        description: `Only ${recent5Wins} wins in 5 games, conceding ${recent5Conceded} goals. Immediate tactical intervention required.`,
        impact: 'Critical - Consider formation changes or squad rotation'
      });
    }
    
    // CLEAN SHEET ANALYSIS
    const cleanSheets = data.filter(m => m.goalsConceded === 0).length;
    const cleanSheetRate = (cleanSheets / data.length) * 100;
    
    if (cleanSheetRate >= 35) {
      insights.push({
        title: '🏰 Defensive Fortress',
        description: `${cleanSheetRate.toFixed(0)}% clean sheet rate demonstrates excellent defensive structure. Your backline is your biggest strength.`,
        impact: 'Positive - Use defensive solidity as platform for counter-attacks'
      });
    } else if (cleanSheetRate < 15) {
      insights.push({
        title: '🚨 Defensive Vulnerability',
        description: `Only ${cleanSheetRate.toFixed(0)}% clean sheets suggests systemic defensive issues. Focus on shape, positioning, and communication.`,
        impact: 'High Priority - Defensive coaching and set-piece work needed'
      });
    }
    
    // ATTACKING PATTERNS
    const avgGoalsPerWin = wins.length > 0 ? wins.reduce((sum, m) => sum + m.goalsScored, 0) / wins.length : 0;
    const avgGoalsPerLoss = losses.length > 0 ? losses.reduce((sum, m) => sum + m.goalsScored, 0) / losses.length : 0;
    
    if (avgGoalsPerWin >= 2.5) {
      insights.push({
        title: '⚡ High-Octane Attack',
        description: `You average ${avgGoalsPerWin.toFixed(1)} goals when winning. Your attacking system creates multiple chances when clicking.`,
        impact: 'Maintain attacking tempo - create more goal-scoring opportunities'
      });
    } else if (avgGoalsPerLoss < 1.0 && losses.length > 2) {
      insights.push({
        title: '🔄 Creative Struggles',
        description: `Averaging only ${avgGoalsPerLoss.toFixed(1)} goals in defeats. Need more creativity and movement in final third.`,
        impact: 'Medium - Work on attacking patterns and player movement'
      });
    }
    
    // GAME MANAGEMENT
    const comebacks = data.filter(m => m.result === 'W' && m.goalsConceded > 0).length;
    const comebackRate = data.length > 0 ? (comebacks / data.length) * 100 : 0;
    
    if (comebackRate >= 20) {
      insights.push({
        title: '💪 Mental Resilience',
        description: `${comebackRate.toFixed(0)}% of games feature comeback wins. Your team shows excellent mental strength under pressure.`,
        impact: 'Positive trait - Continue building team character and belief'
      });
    }
    
    // CONSISTENCY PATTERNS
    const passConsistency = calculateConsistency(data.map(d => d.passSuccess || 0));
    const shotConsistency = calculateConsistency(data.map(d => d.shotSuccess || 0));
    const tackleConsistency = calculateConsistency(data.map(d => d.tackleSuccess || 0));
    
    if (passConsistency > 80) {
      insights.push({
        title: '🎯 Passing Reliability',
        description: `${passConsistency.toFixed(0)}% consistency in passing shows excellent technical discipline across the squad.`,
        impact: 'Strong foundation - Use as platform for more complex tactics'
      });
    } else if (passConsistency < 60) {
      insights.push({
        title: '📊 Technical Inconsistency',
        description: `Pass success varies significantly (${passConsistency.toFixed(0)}% consistent). Need more training on basic technique.`,
        impact: 'Training Focus - Extra passing and technical sessions required'
      });
    }
    
    if (shotConsistency < 50) {
      insights.push({
        title: '🎲 Unpredictable Finishing',
        description: `Shot conversion varies wildly between matches. Finishing is too dependent on individual moments of brilliance.`,
        impact: 'Practice finishing patterns and composure under pressure'
      });
    }
    
    // HEAD-TO-HEAD PATTERNS
    const bigWins = data.filter(m => m.result === 'W' && (m.goalsScored - m.goalsConceded) >= 3).length;
    const bigWinRate = (bigWins / data.length) * 100;
    
    if (bigWinRate >= 15) {
      insights.push({
        title: '🚀 Dominant Victories',
        description: `${bigWinRate.toFixed(0)}% of games are convincing 3+ goal wins. When you're good, you're ruthless.`,
        impact: 'Excellent - Shows ability to kill games and maintain intensity'
      });
    }
    
    // DRAW ANALYSIS
    const drawRate = (draws.length / data.length) * 100;
    if (drawRate >= 25) {
      insights.push({
        title: '⚖️ Too Many Stalemates',
        description: `${drawRate.toFixed(0)}% draw rate suggests difficulty closing out tight games. Need more killer instinct.`,
        impact: 'Tactical adjustment - Work on breaking down defensive opponents'
      });
    }
    
    // RECENT TACTICAL EVOLUTION
    if (data.length >= 10) {
      const first5 = data.slice(0, 5);
      const last5 = data.slice(-5);
      const earlyPass = first5.reduce((sum, m) => sum + (m.passSuccess || 0), 0) / 5;
      const recentPass = last5.reduce((sum, m) => sum + (m.passSuccess || 0), 0) / 5;
      
      if (recentPass > earlyPass + 10) {
        insights.push({
          title: '📈 Technical Evolution',
          description: `Pass success improved by ${(recentPass - earlyPass).toFixed(1)}% over the season. Team is developing better chemistry.`,
          impact: 'Positive trend - Continue current training methods'
        });
      } else if (earlyPass > recentPass + 10) {
        insights.push({
          title: '📉 Form Regression',
          description: `Pass accuracy has declined by ${(earlyPass - recentPass).toFixed(1)}% recently. May indicate fatigue or tactical confusion.`,
          impact: 'Attention needed - Review recent changes and player fitness'
        });
      }
    }
    
    // EFFICIENCY VS VOLUME
    const totalShots = data.reduce((sum, m) => sum + (m.goalsScored / (m.shotSuccess / 100) || 0), 0);
    const avgShotsPerGame = totalShots / data.length;
    
    if (avgShotsPerGame >= 15 && avgShotsInWins >= 25) {
      insights.push({
        title: '🎯 Volume Shooting Strategy',
        description: `High shot volume with quality conversion in wins. Your "spray and pray" approach works when execution improves.`,
        impact: 'Fine-tune shot selection while maintaining attacking intent'
      });
    }
    
    // LATE GAME PATTERNS
    // This would require minute-by-minute data, but we can infer from results
    const narrowWins = wins.filter(m => (m.goalsScored - m.goalsConceded) === 1).length;
    const narrowWinRate = wins.length > 0 ? (narrowWins / wins.length) * 100 : 0;
    
    if (narrowWinRate >= 60) {
      insights.push({
        title: '⏰ Clutch Performance',
        description: `${narrowWinRate.toFixed(0)}% of wins are by single goals. Your team excels in tight, pressure situations.`,
        impact: 'Mental strength asset - Build on clutch mentality'
      });
    }
    
    // Return top 12 most relevant insights
    return insights.slice(0, 12);
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Metric checkboxes - Fixed click handling
    document.getElementById('metricControls').addEventListener('click', function(e) {
      const checkbox = e.target.closest('.checkbox-item');
      if (checkbox) {
        e.preventDefault();
        checkbox.classList.toggle('active');
        if (displayedMatchesData.length > 0) {
          createTrendsChart(displayedMatchesData);
        }
      }
    });
    
    // Match count input
    document.getElementById('matchCountInput').addEventListener('input', function() {
      if (allMatchesData.length > 0) {
        updateDisplayedMatches();
      }
    });
    
    // Show all matches button
    document.getElementById('showAllMatches').addEventListener('click', function() {
      document.getElementById('matchCountInput').value = allMatchesData.length;
      if (allMatchesData.length > 0) {
        updateDisplayedMatches();
      }
    });
    
    loadData();
  });

  async function loadData() {
    try {
      const response = await getJSON('api/matches/all.json');
      const matches = response.matches || [];
      
      if (matches.length === 0) {
        document.querySelectorAll('.loading').forEach(el => {
          el.textContent = 'No match data available. Play some matches to see trends!';
        });
        return;
      }
      
      // Sort chronologically (oldest first for trends)
      const sortedMatches = matches.sort((a, b) => a.match_timestamp - b.match_timestamp);
      allMatchesData = processMatchData(sortedMatches);
      
      // Initialize with default match count
      updateDisplayedMatches();
      
    } catch (error) {
      console.error('Error loading data:', error);
      document.querySelectorAll('.loading').forEach(el => {
        el.textContent = 'Failed to load data. Please refresh the page.';
      });
    }
  }
})();
</script>
</body>
</html>
