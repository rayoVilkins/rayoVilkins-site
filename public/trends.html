<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rayo Vilkins - Performance Trends</title>
<style>
  :root{
    --bg:#0f0f0f; --card:#1a1a1a; --text:#ffffff; --muted:#a1a1aa; --line:#333333;
    --active-bg:#1e40af; --active-br:#3b82f6; --active-tx:#ffffff;
    --win:#22c55e; --loss:#ef4444; --draw:#f59e0b;
    --match-bg:#1f1f1f;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body::after{content:"";display:block;height:120px}

  /* Header / Nav */
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line)}
  .bar{max-width:1500px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 14px}
  .brand{font-weight:800;letter-spacing:.2px;font-size:14px;opacity:.9;color:var(--text)}
  .brand a{color:inherit;text-decoration:none}
  .spacer{flex:1}

  /* Page Layout */
  .wrap{max-width:1400px;margin:16px auto;padding:0 12px}
  .page-header{text-align:center;margin-bottom:24px}
  .page-title{font-size:28px;font-weight:800;color:var(--text);margin-bottom:8px}
  .page-subtitle{color:var(--muted);font-size:14px}

  /* Grid Layout */
  .trends-grid{display:grid;grid-template-columns:1fr;gap:20px}
  .section-card{background:var(--card);border-radius:12px;padding:20px;border:1px solid var(--line)}
  .section-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}
  .section-subtitle{font-size:12px;color:var(--muted);margin-bottom:12px}

  /* Chart Controls */
  .chart-controls{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px;padding:16px;background:var(--match-bg);border-radius:8px;border:1px solid var(--line)}
  .control-group{display:flex;flex-direction:column;gap:6px}
  .control-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
  .checkbox-group{display:flex;flex-wrap:wrap;gap:8px}
  .checkbox-item{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg);border:1px solid var(--line);border-radius:6px;cursor:pointer;transition:all .2s;user-select:none}
  .checkbox-item:hover{border-color:var(--active-br)}
  .checkbox-item.active{background:var(--active-bg);color:var(--active-tx);border-color:var(--active-br)}
  .stat-color{width:12px;height:12px;border-radius:2px;margin-right:4px}

  /* Match Count Input */
  .match-count-input{background:var(--bg);color:var(--text);border:1px solid var(--line);border-radius:6px;padding:6px 10px;width:80px}
  .match-count-controls{display:flex;gap:8px;align-items:center}

  /* Chart Container */
  .chart-container{position:relative;height:400px;background:var(--match-bg);border-radius:8px;padding:16px}
  .chart-canvas{width:100% !important;height:100% !important}

  /* Form Strip */
  .form-strip{display:flex;justify-content:center;gap:4px;margin-bottom:16px}
  .form-match{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;border:2px solid var(--line)}
  .form-match.win{background:var(--win);color:#fff;border-color:var(--win)}
  .form-match.loss{background:var(--loss);color:#fff;border-color:var(--loss)}
  .form-match.draw{background:var(--draw);color:#111827;border-color:var(--draw)}

  /* Stats Grid */
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
  .stat-item{background:var(--match-bg);padding:16px;border-radius:8px;border:1px solid var(--line);text-align:center}
  .stat-value{font-size:24px;font-weight:800;color:var(--text);margin-bottom:4px}
  .stat-value.positive{color:var(--win)}
  .stat-value.negative{color:var(--loss)}
  .stat-value.neutral{color:var(--draw)}
  .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .stat-trend{font-size:11px;color:var(--muted);margin-top:4px}

  /* Responsive */
  @media (max-width: 768px) {
    .wrap{padding:0 8px}
    .chart-controls{flex-direction:column}
    .checkbox-group{justify-content:center}
    .stats-grid{grid-template-columns:repeat(2,1fr)}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><a href="matches.html">Rayo Vilkins FC</a></div>
      <div class="spacer"></div>
    </div>
  </header>

  <div class="wrap">
    <div class="page-header">
      <h1 class="page-title">Performance Trends & Insights</h1>
      <p class="page-subtitle">Deep analysis of your team's performance patterns over time</p>
    </div>

    <div class="trends-grid">
      <!-- Performance Trends Chart -->
      <div class="section-card">
        <h2 class="section-title">ðŸ“ˆ Performance Efficiency Trends</h2>
        <p class="section-subtitle">Track key performance metrics over your match sequence</p>
        
        <div class="chart-controls">
          <div class="control-group">
            <label class="control-label">Metrics to Display</label>
            <div class="checkbox-group" id="metricControls">
              <div class="checkbox-item active" data-metric="passSuccess">
                <div class="stat-color" style="background:#8b5cf6"></div>
                Pass Success %
              </div>
              <div class="checkbox-item active" data-metric="tackleSuccess">
                <div class="stat-color" style="background:#06b6d4"></div>
                Tackle Success %
              </div>
              <div class="checkbox-item active" data-metric="shotSuccess">
                <div class="stat-color" style="background:#f97316"></div>
                Shot Success %
              </div>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label">Match Count</label>
            <div class="match-count-controls">
              <input type="number" id="matchCountInput" class="match-count-input" value="20" min="5" max="999">
              <button id="showAllMatches" style="background:var(--bg);color:var(--text);border:1px solid var(--line);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px">Show All</button>
            </div>
          </div>
        </div>
        
        <div class="chart-container">
          <canvas id="trendsChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Current Form & Key Stats -->
      <div class="section-card">
        <h2 class="section-title">ðŸ”¥ Current Form & Key Metrics</h2>
        <p class="section-subtitle">Recent performance and season averages</p>
        
        <div id="formStrip" class="form-strip">
          <div class="loading">Loading recent form...</div>
        </div>
        
        <div id="keyStats" class="stats-grid">
          <div class="loading">Loading statistics...</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const OUR_CLUB_ID = '63719';
  const API_BASE = '';

  let allMatchesData = [];
  let displayedMatchesData = [];
  let trendsChart = null;

  // Chart colors
  const COLORS = {
    passSuccess: '#8b5cf6',
    tackleSuccess: '#06b6d4',
    shotSuccess: '#f97316'
  };

  const RESULT_COLORS = { 'W':'#22c55e', 'D':'#fbbf24', 'L':'#ef4444' };

  async function getJSON(path){
    const res = await fetch(`${API_BASE}${path}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function processMatchData(matches) {
    return matches.map((match, index) => {
      const passSuccess = match.our_passes_made && match.our_pass_attempts ?
        (parseInt(match.our_passes_made) / parseInt(match.our_pass_attempts)) * 100 : 0;

      const tackleSuccess = match.our_tackles_made && match.our_tackle_attempts ?
        (parseInt(match.our_tackles_made) / parseInt(match.our_tackle_attempts)) * 100 : 0;

      const shotSuccess = match.our_goals && match.our_shots ?
        (parseInt(match.our_goals) / parseInt(match.our_shots)) * 100 : 0;

      const goalsScored = parseInt(match.our_goals) || 0;
      const goalsConceded = parseInt(match.opponent_goals) || 0;

      return {
        matchNumber: index + 1,
        opponent: match.opponent_club_name,
        date: match.match_date,
        result: match.result,
        passSuccess, tackleSuccess, shotSuccess,
        goalsScored, goalsConceded,
        ourGoals: goalsScored, oppGoals: goalsConceded,
        isValid: !(passSuccess === 100 && (goalsScored + goalsConceded) <= 3)
      };
    }).filter(m => m.isValid);
  }

  function getActiveMetrics(){
    return Array.from(document.querySelectorAll('#metricControls .checkbox-item.active'))
      .map(el => el.getAttribute('data-metric'));
  }

  function updateDisplayedMatches() {
    const matchCount = parseInt(document.getElementById('matchCountInput').value);
    const totalMatches = allMatchesData.length;

    displayedMatchesData = matchCount >= totalMatches
      ? [...allMatchesData]
      : allMatchesData.slice(-matchCount);

    if (displayedMatchesData.length > 0) {
      createTrendsChart(displayedMatchesData);
      renderFormStrip(displayedMatchesData);
      renderKeyStats(displayedMatchesData);
    }
  }

  // ---- Amplified (auto-zoomed) Y-axis for more pronounced changes ----
  function computeYAxisRange(data, activeMetrics){
    const values = [];
    activeMetrics.forEach(metric => {
      data.forEach(d => {
        const v = d[metric];
        if (typeof v === 'number' && isFinite(v)) values.push(v);
      });
    });
    if (values.length === 0) return {min:0, max:100};

    let min = Math.min(...values);
    let max = Math.max(...values);

    // Ensure there is a visible span
    let span = Math.max(max - min, 3); // at least 3%
    const pad = Math.max(2, span * 0.25); // 25% padding (>=2%)

    min = Math.max(0, Math.floor(min - pad));
    max = Math.min(100, Math.ceil(max + pad));

    // If still too tight, widen a touch
    if (max - min < 10){
      const extra = (10 - (max - min)) / 2;
      min = Math.max(0, min - extra);
      max = Math.min(100, max + extra);
    }
    return {min, max};
  }

  function createTrendsChart(data) {
    const ctx = document.getElementById('trendsChart').getContext('2d');

    const activeMetrics = getActiveMetrics();
    const datasets = [];

    activeMetrics.forEach(metric => {
      const pointColors = data.map(d => RESULT_COLORS[d.result]);
      const pointBorderColors = pointColors;

      datasets.push({
        label: getMetricLabel(metric),
        data: data.map(d => d[metric]),
        borderColor: COLORS[metric],
        backgroundColor: COLORS[metric] + '24',
        borderWidth: 3,                 // thicker line for readability
        fill: false,
        tension: 0.35,
        pointBackgroundColor: pointColors,
        pointBorderColor: pointBorderColors,
        pointBorderWidth: 2,
        pointRadius: 5,
        pointHoverRadius: 8
      });
    });

    if (trendsChart) trendsChart.destroy();

    const yRange = computeYAxisRange(data, activeMetrics);

    trendsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => `Match ${d.matchNumber}`),
        datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#ffffff',
              usePointStyle: true,
              padding: 20,
              generateLabels(chart){
                const base = Chart.defaults.plugins.legend.labels.generateLabels.call(this, chart);
                base.push(
                  { text: 'Win',  fillStyle: '#22c55e', strokeStyle: '#22c55e', pointStyle: 'circle' },
                  { text: 'Draw', fillStyle: '#f59e0b', strokeStyle: '#f59e0b', pointStyle: 'circle' },
                  { text: 'Loss', fillStyle: '#ef4444', strokeStyle: '#ef4444', pointStyle: 'circle' }
                );
                return base;
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: '#1a1a1a',
            titleColor: '#ffffff',
            bodyColor: '#a1a1aa',
            borderColor: '#333333',
            borderWidth: 1,
            callbacks: {
              title(context){
                const match = data[context[0].dataIndex];
                return `vs ${match.opponent} (${match.date})`;
              },
              afterTitle(context){
                const match = data[context[0].dataIndex];
                return `Result: ${match.ourGoals}-${match.oppGoals} (${match.result})`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: { color: '#333333' },
            ticks: { color: '#a1a1aa' }
          },
          y: {
            grid: { color: '#333333' },
            ticks: {
              color: '#a1a1aa',
              callback: v => v.toFixed(0) + '%'
            },
            min: yRange.min,
            max: yRange.max,
            beginAtZero: false
          }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false }
      }
    });
  }

  function getMetricLabel(metric) {
    const labels = {
      passSuccess: 'Pass Success %',
      tackleSuccess: 'Tackle Success %',
      shotSuccess: 'Shot Success %'
    };
    return labels[metric] || metric;
  }

  function renderFormStrip(data) {
    const recent = data.slice(-10);
    const container = document.getElementById('formStrip');
    container.innerHTML = recent.map(match => 
      `<div class="form-match ${match.result.toLowerCase()}" title="vs ${match.opponent}: ${match.ourGoals}-${match.oppGoals}">
        ${match.result}
      </div>`
    ).join('');
  }

  function renderKeyStats(data) {
    const container = document.getElementById('keyStats');
    if (data.length === 0) {
      container.innerHTML = '<div class="loading">No match data available</div>';
      return;
    }

    const avgPasses = data.reduce((s, m) => s + (m.passSuccess || 0), 0) / data.length;
    const avgTackles = data.reduce((s, m) => s + (m.tackleSuccess || 0), 0) / data.length;
    const avgShots = data.reduce((s, m) => s + (m.shotSuccess || 0), 0) / data.length;
    const winRate = (data.filter(m => m.result === 'W').length / data.length) * 100;
    const avgGoalsFor = data.reduce((s, m) => s + (m.goalsScored || 0), 0) / data.length;
    const avgGoalsAgainst = data.reduce((s, m) => s + (m.goalsConceded || 0), 0) / data.length;

    const recent5 = data.slice(-5);
    const recent5WinRate = recent5.length ? (recent5.filter(m => m.result === 'W').length / recent5.length) * 100 : 0;
    const formTrend = recent5WinRate > winRate ? 'positive' : (recent5WinRate < winRate ? 'negative' : 'neutral');

    const currentStreak = calculateCurrentStreak(data);

    container.innerHTML = `
      <div class="stat-item">
        <div class="stat-value">${avgPasses.toFixed(1)}%</div>
        <div class="stat-label">Pass Success</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgTackles.toFixed(1)}%</div>
        <div class="stat-label">Tackle Success</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgShots.toFixed(1)}%</div>
        <div class="stat-label">Shot Success</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgGoalsFor.toFixed(1)}</div>
        <div class="stat-label">Goals Per Game</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${avgGoalsAgainst.toFixed(1)}</div>
        <div class="stat-label">Goals Against</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${winRate.toFixed(1)}%</div>
        <div class="stat-label">Win Rate</div>
        <div class="stat-trend">Overall</div>
      </div>
      <div class="stat-item">
        <div class="stat-value ${formTrend}">${recent5WinRate.toFixed(1)}%</div>
        <div class="stat-label">Recent Form</div>
        <div class="stat-trend">Last ${recent5.length} matches</div>
      </div>
      <div class="stat-item">
        <div class="stat-value ${currentStreak.type}">${currentStreak.count}</div>
        <div class="stat-label">Current Streak</div>
        <div class="stat-trend">${currentStreak.text}</div>
      </div>
    `;
  }

  function calculateCurrentStreak(data) {
    if (!data.length) return { count: 0, type: 'neutral', text: 'No matches' };
    const lastResult = data[data.length - 1].result;
    let count = 1;
    for (let i = data.length - 2; i >= 0; i--) {
      if (data[i].result === lastResult) count++; else break;
    }
    const type = lastResult === 'W' ? 'positive' : (lastResult === 'L' ? 'negative' : 'neutral');
    const text = lastResult === 'W' ? 'Win streak' : (lastResult === 'L' ? 'Loss streak' : 'Draw streak');
    return { count, type, text };
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('metricControls').addEventListener('click', function(e) {
      const checkbox = e.target.closest('.checkbox-item');
      if (checkbox) {
        e.preventDefault();
        checkbox.classList.toggle('active');
        if (displayedMatchesData.length) createTrendsChart(displayedMatchesData);
      }
    });

    document.getElementById('matchCountInput').addEventListener('input', function() {
      if (allMatchesData.length) updateDisplayedMatches();
    });

    document.getElementById('showAllMatches').addEventListener('click', function() {
      document.getElementById('matchCountInput').value = allMatchesData.length;
      if (allMatchesData.length) updateDisplayedMatches();
    });

    loadData();
  });

  async function loadData() {
    try {
      const response = await getJSON('api/matches/all.json');
      const matches = response.matches || [];
      if (!matches.length) {
        document.querySelectorAll('.loading').forEach(el => {
          el.textContent = 'No match data available. Play some matches to see trends!';
        });
        return;
      }
      const sorted = matches.sort((a,b) => a.match_timestamp - b.match_timestamp);
      allMatchesData = processMatchData(sorted);
      updateDisplayedMatches();
    } catch (err) {
      console.error(err);
      document.querySelectorAll('.loading').forEach(el => {
        el.textContent = 'Failed to load data. Please refresh the page.';
      });
    }
  }
})();
</script>
</body>
</html>
