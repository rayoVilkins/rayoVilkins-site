<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rayo Vilkins - Matches</title>
<style>
  :root{
    --bg:#0f0f0f; --card:#1a1a1a; --text:#ffffff; --muted:#a1a1aa; --line:#333333;
    --rail:#facc15; --rail-dark:#f59e0b; --active-bg:#1e40af; --active-br:#3b82f6; --active-tx:#ffffff;
    --score:#ffffff; --win:#22c55e; --loss:#ef4444; --draw:#f59e0b;
    --navy:#ffffff; --pitch:#1a2e1a;
    --match-bg:#1f1f1f; --match-hover:#2a2a2a; --ft-bg:#333333;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body::after{content:"";display:block;height:120px}

  /* Header / Nav */
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line)}
  .bar{max-width:1500px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 14px}
  .brand{font-weight:800;letter-spacing:.2px;font-size:14px;opacity:.9;color:var(--text)}
  .brand a{color:inherit;text-decoration:none}
  nav{display:flex;gap:6px}
  nav a{color:var(--muted);text-decoration:none;font-size:13px;padding:6px 10px;border-radius:8px;border:1px solid transparent}
  nav a[aria-current="page"]{background:var(--active-bg);border-color:var(--active-br);color:var(--active-tx)}
  nav a:hover{color:var(--text)}
  .spacer{flex:1}

  /* Page */
  .wrap{max-width:1200px;margin:14px auto 100px;padding:0 12px}

  /* Top Section   */
  .top-section{background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid var(--line)}
  
  /* Filters */
  .filters{display:grid;grid-template-columns:auto auto 1fr auto auto;gap:12px;align-items:end;margin-bottom:16px}
  .filter-group{display:flex;flex-direction:column;gap:4px}
  .filter-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
  .filters input[type="date"], .filters input[type="text"]{background:var(--bg);color:var(--text);border:1px solid var(--line);border-radius:6px;padding:8px 10px;font-size:13px;min-width:140px}
  .filters input[type="text"]{min-width:200px}
  .filters button{background:var(--active-bg);color:var(--active-tx);border:none;border-radius:6px;padding:8px 16px;font-size:13px;cursor:pointer}
  .filters button:hover{background:var(--active-br)}

  /* Summary */
  .summary{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;margin-top:10px}
  .summary-card{background:var(--bg);border:1px solid var(--line);border-radius:8px;padding:16px;text-align:center}
  .summary-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
  .summary-value{font-size:24px;font-weight:700;color:var(--text)}
  .summary-value.win{color:var(--win)}
  .summary-value.loss{color:var(--loss)}
  .summary-value.draw{color:var(--draw)}

  /* Match results */
  .board-section{margin-bottom:32px}
  .board-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:12px;text-align:center;padding:8px 12px;background:var(--card);border-radius:8px;border:1px solid var(--line)}
  .match-result{display:flex;align-items:center;background:var(--match-bg);border:1px solid var(--line);border-radius:12px;padding:12px 16px;margin-bottom:8px;cursor:pointer;transition:background 0.2s}
  .match-result:hover{background:var(--match-hover)}
  .ft-indicator{background:var(--ft-bg);color:var(--text);font-size:11px;font-weight:600;padding:4px 8px;border-radius:4px;margin-right:16px;min-width:28px;text-align:center}
  .match-content{display:flex;align-items:center;flex:1;gap:16px}
  .team-section{display:flex;align-items:center;gap:8px;min-width:160px}
  .team-section.home{justify-content:flex-end}
  .team-section.away{justify-content:flex-start}
  .team-name{font-size:15px;font-weight:500;color:var(--text)}
  .score-section{display:flex;align-items:center;gap:8px;font-size:20px;font-weight:700;min-width:80px;justify-content:center}
  .score-section.win{color:var(--win)}
  .score-section.loss{color:var(--loss)}
  .score-section.draw{color:var(--draw)}
  .score-separator{color:var(--muted);font-weight:400}
  .team-crest{width:24px;height:24px;object-fit:contain}
  .team-crest.placeholder{background:var(--line);border-radius:2px}
  .match-date{font-size:12px;color:var(--muted);text-align:right;min-width:140px}
  
  /* Pager */
  .pager{display:flex;align-items:center;justify-content:center;gap:12px;margin:20px 0;padding:16px;background:var(--card);border-radius:8px;border:1px solid var(--line)}
  .pager button{background:var(--active-bg);color:var(--active-tx);border:none;border-radius:6px;padding:8px 16px;font-size:13px;cursor:pointer}
  .pager button:disabled{background:var(--line);color:var(--muted);cursor:not-allowed}
  .pager button:not(:disabled):hover{background:var(--active-br)}
  .pager .info{color:var(--muted);font-size:13px;margin-left:12px}

  /* Status/Info */
  .info{text-align:center;color:var(--muted);font-style:italic;padding:20px}
  .error{text-align:center;color:var(--loss);padding:20px}

  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1000;overflow-y:auto}
  .modal-overlay.show{display:flex}
  .modal{background:var(--card);border-radius:12px;width:90%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;border:1px solid var(--line)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line);flex-shrink:0}
  .modal-close{background:none;border:none;font-size:24px;color:var(--muted);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px}
  .modal-close:hover{background:var(--match-hover);color:var(--text)}

  /* Modal match info */
  .modal-match-info{font-size:13px;color:var(--muted);margin-bottom:8px}
  .match-score-header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:20px}
  .modal-team{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;color:var(--text)}
  .modal-team.left{justify-content:flex-end}
  .modal-team.right{justify-content:flex-start}
  .modal-crest{width:26px;height:26px;object-fit:contain}
  .modal-score-section{text-align:center}
  .modal-final-score{font-size:32px;font-weight:800;color:var(--text)}
  .ms-win{color:var(--win)}
  .ms-loss{color:var(--loss)}
  .ms-draw{color:var(--draw)}

  .match-events{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;margin-top:6px}
  .events-left{text-align:right}
  .events-right{text-align:left}
  .events-center{text-align:center;font-size:12px;opacity:.7;color:var(--muted)}
  .event-line{margin-bottom:1px;font-size:13px;color:var(--text)}

  .modal-content{overflow-y:auto;flex:1;background:var(--card)}
  .tab-navigation{display:flex;background:var(--bg);border-bottom:1px solid var(--line);flex-shrink:0}
  .tab-button{flex:1;padding:10px 16px;background:none;border:none;font-size:14px;font-weight:500;cursor:pointer;border-bottom:3px solid transparent;color:var(--muted)}
  .tab-button.active{background:var(--card);border-bottom-color:var(--rail);color:var(--text)}
  .tab-button:hover:not(.active){background:var(--match-hover);color:var(--text)}
  .tab-content{display:none;padding:8px;height:100%}
  .tab-content.active{display:block}

  /* Formation / Pitch - Compact for no scroll */
  .lineups-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;height:100%}
  .formation-section{display:flex;flex-direction:column;height:100%}
  .formation-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;padding:0 4px}
  .team-title{font-weight:700;color:var(--text);font-size:14px}
  .formation-label{font-size:10px;color:var(--muted);background:var(--bg);padding:2px 5px;border-radius:3px}
  
  .pitch{position:relative;background:linear-gradient(180deg,#2a2a2a 0%,#1f1f1f 100%);border:2px solid var(--line);border-radius:8px;height:360px;overflow:hidden;flex:1;box-shadow:inset 0 2px 8px rgba(0,0,0,0.3)}
  
  /* Pitch markings */
  .pitch::before{content:"";position:absolute;top:50%;left:50%;width:90px;height:90px;border:1px solid #404040;border-radius:50%;transform:translate(-50%,-50%)}
  .pitch::after{content:"";position:absolute;top:50%;left:50%;width:5px;height:5px;background:#404040;border-radius:50%;transform:translate(-50%,-50%)}
  
  .slot{position:absolute;display:flex;flex-direction:column;align-items:center;transform:translate(-50%,-50%)}
  .badge{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;border:2px solid var(--line);color:var(--text);box-shadow:0 2px 4px rgba(0,0,0,0.3)}
  .badge.home{background:var(--rail);color:#111827;border-color:var(--rail-dark)}
  .badge.away{background:var(--loss);border-color:#dc2626}
  .badge.bot{background:var(--line);color:var(--muted)}
  .player-label{position:absolute;top:24px;font-size:8px;color:var(--text);background:rgba(0,0,0,0.7);padding:1px 4px;border-radius:3px;white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis}

  /* Stats bars */
  .bars{display:flex;flex-direction:column;gap:12px;padding:12px}
  .bar-block{display:flex;flex-direction:column;gap:6px}
  .bar-title{font-size:13px;font-weight:600;color:var(--text);text-align:center}
  .bar-row{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .bar-num{font-size:14px;font-weight:600;color:var(--text);min-width:40px}
  .track{height:8px;background:var(--bg);border-radius:4px;position:relative;overflow:hidden}
  .bar-left,.bar-right{height:100%;position:absolute;top:0;border-radius:4px}
  .bar-left{left:0;background:var(--rail)}
  .bar-right{right:0;background:var(--loss)}

  /* Head-to-head */
  .h2h-summary{margin-bottom:20px}
  .h2h-summary h3{margin:0 0 12px 0;color:var(--text);font-size:18px;text-align:center}
  .h2h-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
  .h2h-stats>div{text-align:center;padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--line)}
  .h2h-stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
  .h2h-stat-value{font-size:20px;font-weight:700;color:var(--text)}
  .h2h-stat-value.wins{color:var(--win)}
  .h2h-stat-value.draws{color:var(--draw)}
  .h2h-stat-value.losses{color:var(--loss)}
  
  /* Updated h2h-match to include team logos */
  .h2h-match{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 12px;background:var(--match-bg);border:1px solid var(--line);border-radius:8px;margin-bottom:6px}
  .h2h-score-section{display:flex;align-items:center;gap:8px;justify-content:center}
  .h2h-team-crest{width:20px;height:20px;object-fit:contain}
  .h2h-score{color:var(--text);font-weight:600;font-size:14px}
  .h2h-score.win{color:var(--win)}
  .h2h-score.draw{color:var(--draw)}
  .h2h-score.loss{color:var(--loss)}
  .h2h-match-date{font-size:12px;color:var(--muted)}

  @media (max-width:768px){
    .wrap{max-width:100%;padding:0 8px}
    
    /* Mobile filters */
    .filters{grid-template-columns:1fr;gap:12px;align-items:stretch}
    .filter-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .search-row{display:grid;grid-template-columns:1fr;gap:8px}
    .button-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .filters input[type="date"], .filters input[type="text"]{min-width:unset;width:100%}
    .filters button{width:100%}
    
    /* Mobile summary */
    .summary{grid-template-columns:repeat(3,1fr);gap:8px}
    .summary-card{padding:12px 8px}
    .summary-value{font-size:20px}
    
    /* Mobile match results */
    .match-result{padding:10px 12px}
    .ft-indicator{margin-right:12px;font-size:10px;padding:3px 6px}
    .team-name{font-size:14px}
    .score-section{font-size:16px}
    .team-crest{width:20px;height:20px}
    
    /* Mobile pager */
    .pager{padding:12px;flex-wrap:wrap;justify-content:center}
    .pager .info{margin-left:0;margin-top:8px;width:100%;text-align:center}
    
    /* Modal adjustments */
    .modal-overlay{align-items:flex-start;overflow-y:auto;padding:12px 0}
    .modal{margin:8px auto;max-width:calc(100% - 16px);width:100%;height:auto;max-height:none;overflow:visible}
    .modal-content{flex:none}
    .lineups-grid{grid-template-columns:1fr;gap:12px;height:auto}
    .pitch{height:auto;min-height:clamp(320px, 120vw, 520px)}
    .badge{width:32px;height:32px;font-size:10px}
    .player-label{font-size:9px;top:20px;max-width:70px}
    .match-score-header{grid-template-columns:1fr;gap:10px;text-align:center}
    .match-events{grid-template-columns:1fr;gap:6px;text-align:center}
    .events-left,.events-right{text-align:center}
  }
  
/* === Line-ups + other tabs: remove inner vertical scrolling and fixed heights === */

/* Let the modal/content expand instead of scrolling internally */
.modal-content,
#lineups.tab-content,
#stats.tab-content,
#h2h.tab-content {
  overflow-y: visible !important;
  height: auto !important;
  max-height: none !important;
}

/* Make the formation/pitch areas flexible height */
.formation-section {
  min-height: 0 !important;
}

.pitch {
  height: auto !important;
  min-height: clamp(360px, 45vw + 200px, 620px);
  overflow: hidden;
}

@media (max-width: 768px) {
  .pitch {
    min-height: clamp(320px, 120vw, 520px);
  }
}

/* Keep if you want explicit spacing on the Line-ups tab */
#lineups.tab-content {
  overflow: visible !important;
  padding-bottom: 8px;
}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><a href="matches.html">Rayo Vilkins FC</a></div>
      <div class="spacer"></div>
      <nav>
        <a href="matches.html" aria-current="page">Matches</a>
        <a href="stats.html">Stats</a>
        <a href="wheel.html">Wheel</a>
      </nav>
    </div>
  </header>
  <div class="wrap">
    <div class="top-section">
      <div class="filters">
        <div class="filter-group filter-row">
          <label class="filter-label">From</label>
          <input type="date" id="fromDate" />
        </div>
        <div class="filter-group filter-row">
          <label class="filter-label">To</label>
          <input type="date" id="toDate" />
        </div>
        <div class="filter-group search-row">
          <label class="filter-label">Search</label>
          <input type="text" id="searchInput" placeholder="Team name..." />
        </div>
        <div class="button-row">
          <button id="apply">Apply</button>
        </div>
        <div class="button-row">
          <button id="reset">Reset</button>
        </div>
      </div>

      <div id="summary" class="summary" style="display:none;"></div>
    </div>

    <div id="status" class="info">Loading matches…</div>
    <div id="boards"></div>
  </div>

  <!-- Modal -->
  <div id="matchModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close">&times;</button>
        <div id="modalMatchInfo"></div>
      </div>
      <div class="modal-content">
        <div class="tab-navigation">
          <button class="tab-button active" data-tab="lineups">Line-ups</button>
          <button class="tab-button" data-tab="stats">Match Stats</button>
          <button class="tab-button" data-tab="h2h">Head-to-head</button>
        </div>
        <div id="lineups" class="tab-content active"></div>
        <div id="stats" class="tab-content"></div>
        <div id="h2h" class="tab-content"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const OUR_CLUB_ID = '63719';
  const API_BASE = '';

  const CREST_BASE = 'https://eafc26.content.easports.com/fifa/fltOnlineAssets/24B23FDE-7835-41C2-87A2-F453DFDB2E82/2024/fcweb/crests/256x256/l';
  const crestUrl = (teamId) => `${CREST_BASE}${parseInt(teamId)||1}.png`;

  function crestEl(teamId, name, side){
    const img = document.createElement('img');
    img.className = 'team-crest ' + (side||'');
    img.src = crestUrl(teamId);
    img.alt = '';
    if(name) img.setAttribute('aria-label', name);
    img.onerror = function(){
      const ph = document.createElement('span');
      ph.className = 'team-crest placeholder ' + (side||'');
      ph.setAttribute('role','img');
      if(name) ph.setAttribute('aria-label', name);
      img.replaceWith(ph);
    };
    return img;
  }

  const el = {
    from: document.getElementById('fromDate'),
    to: document.getElementById('toDate'),
    search: document.getElementById('searchInput'),
    apply: document.getElementById('apply'),
    reset: document.getElementById('reset'),
    boards: document.getElementById('boards'),
    status: document.getElementById('status'),
    summary: document.getElementById('summary'),
    modal: document.getElementById('matchModal'),
    modalInfo: document.getElementById('modalMatchInfo'),
  };

  const toISODateLocal = (d) => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  function defaultDates(){ const t=new Date(); const past=new Date(t); past.setDate(t.getDate()-30); return {from:toISODateLocal(past), to:toISODateLocal(t)}; }
  const startUnix = (d) => Math.floor(new Date(d+'T00:00:00').getTime()/1000);
  const endUnix   = (d) => Math.floor(new Date(d+'T23:59:59').getTime()/1000);
  function h(tag, attrs={}, ...kids){ const n=document.createElement(tag); for(const [k,v] of Object.entries(attrs||{})){ if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else n.setAttribute(k,v); } kids.flat().filter(Boolean).forEach(k=> n.appendChild(typeof k==='string'? document.createTextNode(k): k)); return n; }
  function fmtDate(sec){ const d=new Date(sec*1000); return d.toLocaleString([], {year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'}); }

  // Modal open/close
  function openModal(matchId){ el.modal.classList.add('show'); loadMatchDetails(matchId); }
  function closeModal(){ el.modal.classList.remove('show'); }
  el.modal.addEventListener('click', (e)=>{ if(e.target===el.modal) closeModal(); });
  document.querySelector('.modal-close').addEventListener('click', closeModal);
  document.querySelectorAll('.tab-button').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
  function switchTab(tab){ document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelector(`[data-tab="${tab}"]`).classList.add('active'); document.getElementById(tab).classList.add('active'); }

  async function getJSON(path){
    const res = await fetch(`${API_BASE}${path}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  // -------- MATCH DETAILS (modal) ----------
  async function loadMatchDetails(matchId) {
    try {
      const response = await getJSON(`api/matches/${matchId}/detailed.json`);
      const { match, clubs = [], players = [], aggregates = [], head_to_head = {} } = response;

      renderMatchHeader(match, clubs, players);
      renderLineups(clubs, players);
      renderMatchStats(Array.isArray(aggregates) ? aggregates : []);

      // Use the new simplified head-to-head data structure
      const summary = head_to_head.summary || { played: 0, our_wins: 0, draws: 0, our_losses: 0 };
      const h2hMatches = head_to_head.matches || [];
      const opponentInfo = head_to_head.opponent_info || { club_name: 'Unknown', team_id: 1 };
      
      renderHeadToHead(summary, h2hMatches, opponentInfo);
    } catch (error) {
      console.error('Error loading match details:', error);
      el.modalInfo.innerHTML = '<div class="error">Failed to load match details</div>';
    }
  }

  function renderMatchHeader(match, clubs, players) {
    const ourClub = clubs.find(c => c.club_id === OUR_CLUB_ID);
    const oppClub = clubs.find(c => c.club_id !== OUR_CLUB_ID);
    if (!ourClub || !oppClub) return;

    const ourGoals = players.filter(p => p.club_id === OUR_CLUB_ID && p.goals > 0)
      .map(p => `${p.player_name} (${p.goals})`).join(', ');
    const ourAssists = players.filter(p => p.club_id === OUR_CLUB_ID && p.assists > 0)
      .map(p => `${p.player_name} (${p.assists})`).join(', ');
    const oppGoals = players.filter(p => p.club_id !== OUR_CLUB_ID && p.goals > 0)
      .map(p => `${p.player_name} (${p.goals})`).join(', ');
    const oppAssists = players.filter(p => p.club_id !== OUR_CLUB_ID && p.assists > 0)
      .map(p => `${p.player_name} (${p.assists})`).join(', ');

    const result = ourClub.goals>oppClub.goals ? 'ms-win' : (ourClub.goals<oppClub.goals ? 'ms-loss' : 'ms-draw');

    const leftCrest  = crestUrl(ourClub.team_id || ourClub.teamId || 480);
    const rightCrest = crestUrl(oppClub.team_id || oppClub.teamId || 1);

    el.modalInfo.innerHTML = `
      <div class="modal-match-info">${fmtDate(match.match_timestamp)}</div>
      <div class="match-score-header">
        <div class="modal-team left">
          <span>${ourClub.club_name}</span>
          <img class="modal-crest" src="${leftCrest}" alt="">
        </div>
        <div class="modal-score-section">
          <div class="modal-final-score ${result}">${ourClub.goals} - ${oppClub.goals}</div>
        </div>
        <div class="modal-team right">
          <img class="modal-crest" src="${rightCrest}" alt="">
          <span>${oppClub.club_name}</span>
        </div>
      </div>
      <div class="match-events">
        <div class="events-left">
          ${ourGoals   ? `<div class="event-line">⚽ ${ourGoals}</div>`   : ''}
          ${ourAssists ? `<div class="event-line">🎯 ${ourAssists}</div>` : ''}
        </div>
        <div class="events-center"><div>FT</div></div>
        <div class="events-right">
          ${oppGoals   ? `<div class="event-line">⚽ ${oppGoals}</div>`   : ''}
          ${oppAssists ? `<div class="event-line">🎯 ${oppAssists}</div>` : ''}
        </div>
      </div>
    `;
  }

  /* -------------------- FORMATION RENDERING -------------------- */
  function renderLineups(clubs, players) {
    const our = players.filter(p=>p.club_id===OUR_CLUB_ID);
    const opp = players.filter(p=>p.club_id!==OUR_CLUB_ID);
    const ourClub = clubs.find(c=>c.club_id===OUR_CLUB_ID);
    const oppClub = clubs.find(c=>c.club_id!==OUR_CLUB_ID);

    function byRole(ps, role){ return ps.filter(p => (p.assigned_position||'').toUpperCase()===role); }

    function build(teamPlayers, teamName, side){
      const gks = byRole(teamPlayers,'GK');
      const lbs = byRole(teamPlayers,'LB');
      const rbs = byRole(teamPlayers,'RB');
      const cbs = byRole(teamPlayers,'CB');
      const dms = byRole(teamPlayers,'DM');
      const ams = byRole(teamPlayers,'AM');
      const sts = byRole(teamPlayers,'ST');

      const totalPlayers = teamPlayers.length;
      const dmCount = dms.length;
      const useDoubleDM = dmCount >= 2 || (dmCount === 1 && totalPlayers < 5);
      const formationName = useDoubleDM ? '4-2-3-1' : '4-1-4-1';

      const base = [];
      base.push({role:'GK', x:50, y:8});
      base.push({role:'LB', x:20, y:26});
      base.push({role:'CB', x:40, y:26});
      base.push({role:'CB', x:60, y:26});
      base.push({role:'RB', x:80, y:26});

      if (useDoubleDM) {
        base.push({role:'DM', x:40, y:46});
        base.push({role:'DM', x:60, y:46});
        base.push({role:'AM', x:30, y:66});
        base.push({role:'AM', x:50, y:66});
        base.push({role:'AM', x:70, y:66});
      } else {
        base.push({role:'DM', x:50, y:46});
        base.push({role:'AM', x:20, y:66});
        base.push({role:'AM', x:40, y:66});
        base.push({role:'AM', x:60, y:66});
        base.push({role:'AM', x:80, y:66});
      }

      base.push({role:'ST', x:50, y:86});

      const pop = (arr)=>arr.length ? arr.shift() : null;

      function pick(slot){
        let p=null;
        if(slot.role==='GK'){ p=pop(gks); }
        else if(slot.role==='LB'){ p=pop(lbs); }
        else if(slot.role==='RB'){ p=pop(rbs); }
        else if(slot.role==='CB'){ p=pop(cbs); }
        else if(slot.role==='DM'){ p=pop(dms); }
        else if(slot.role==='AM'){ p=pop(ams); }
        else if(slot.role==='ST'){ p=pop(sts); }
        if(!p) return {isBot:true,name:'Bot',rating:'—'};
        return {isBot:false,name:p.player_name||'—',rating:(p.rating? Number(p.rating).toFixed(1):'—')};
      }

      const dots = base.map(s=>{
        const pl = pick(s);
        const badgeClass = pl.isBot ? 'badge bot' : ('badge ' + (side==='home' ? 'home':'away'));
        return `
          <div class="slot" style="left:${s.x}%; top:${s.y}%">
            <div class="${badgeClass}">${pl.rating}</div>
            <div class="player-label">${pl.name}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="formation-section">
          <div class="formation-header">
            <div class="team-title">${teamName}</div>
            <div class="formation-label">${formationName}</div>
          </div>
          <div class="pitch">
            ${dots}
          </div>
        </div>
      `;
    }

    document.getElementById('lineups').innerHTML = `
      <div class="lineups-grid">
        ${build(our, ourClub?.club_name || 'Our Team', 'home')}
        ${build(opp, oppClub?.club_name || 'Opponent', 'away')}
      </div>
    `;
  }

  /* -------------------- STATS (bars) -------------------- */
  function makeBar(label, leftValue, rightValue, leftBasis, rightBasis){
    let leftPct, rightPct;
    if (typeof leftBasis === 'number' && typeof rightBasis === 'number') {
      leftPct  = Math.max(0, Math.min(100, leftBasis));
      rightPct = Math.max(0, Math.min(100, rightBasis));
    } else {
      const total = Math.max(
        (Number(String(leftValue).replace('%',''))||0) +
        (Number(String(rightValue).replace('%',''))||0), 1);
      leftPct  = (Number(String(leftValue).replace('%',''))||0)/total*100;
      rightPct = (Number(String(rightValue).replace('%',''))||0)/total*100;
    }
    return `
      <div class="bar-block">
        <div class="bar-title">${label}</div>
        <div class="bar-row">
          <div class="bar-num">${leftValue}</div>
          <div class="track">
            <div class="bar-left"  style="width:${leftPct}%"></div>
            <div class="bar-right" style="width:${rightPct}%"></div>
          </div>
          <div class="bar-num" style="text-align:right">${rightValue}</div>
        </div>
      </div>
    `;
  }

  function renderMatchStats(aggregates) {
    const our = aggregates.find(a => a.club_id === OUR_CLUB_ID);
    const opp = aggregates.find(a => a.club_id !== OUR_CLUB_ID);
    if (!our || !opp) {
      document.getElementById('stats').innerHTML = '<div class="error">Match statistics not available</div>';
      return;
    }

    const shotsO = our.shots||0,   shotsT = opp.shots||0;
    const paO    = our.passattempts||0, paT = opp.passattempts||0;
    const pmO    = our.passesmade||0,   pmT = opp.passesmade||0;
    const taO    = our.tackleattempts||0, taT = opp.tackleattempts||0;
    const tmO    = our.tacklesmade||0,   tmT = opp.tacklesmade||0;

    const psO = paO>0 ? Math.round((pmO/paO)*100) : 0;
    const psT = paT>0 ? Math.round((pmT/paT)*100) : 0;
    const tsO = taO>0 ? Math.round((tmO/taO)*100) : 0;
    const tsT = taT>0 ? Math.round((tmT/taT)*100) : 0;

    const rows = [
      makeBar('Shots', shotsO, shotsT),
      makeBar('Passes Attempted', paO, paT),
      makeBar('Passes Completed', pmO, pmT),
      makeBar('Pass Success %', `${psO}%`, `${psT}%`, psO, psT),
      makeBar('Tackles Attempted', taO, taT),
      makeBar('Tackles Completed', tmO, tmT),
      makeBar('Tackle Success %', `${tsO}%`, `${tsT}%`, tsO, tsT),
    ];
    document.getElementById('stats').innerHTML = `<div class="bars">${rows.join('')}</div>`;
  }

  // FIXED renderHeadToHead function with opponent names and logos
  function renderHeadToHead(summary, matches, opponentInfo) {
    const totalPlayed = summary.played || 0;
    const ourWins = summary.our_wins || 0;
    const draws = summary.draws || 0;
    const ourLosses = summary.our_losses || 0;

    const opponentName = opponentInfo.club_name || 'Unknown';
    const opponentTeamId = opponentInfo.team_id || 1;
    const ourTeamId = 480; // Default Rayo Vilkins team ID

    document.getElementById('h2h').innerHTML = `
      <div class="h2h-summary">
        <h3>Previous Meetings</h3>
        <div class="h2h-stats">
          <div><div class="h2h-stat-label">Played</div><div class="h2h-stat-value">${totalPlayed}</div></div>
          <div><div class="h2h-stat-label">Won</div><div class="h2h-stat-value wins">${ourWins}</div></div>
          <div><div class="h2h-stat-label">Draw</div><div class="h2h-stat-value draws">${draws}</div></div>
          <div><div class="h2h-stat-label">Lost</div><div class="h2h-stat-value losses">${ourLosses}</div></div>
        </div>
      </div>
      ${totalPlayed>0 ? `
        <div class="h2h-matches">
          <h4 style="margin:0 0 8px 0;color:var(--text)">Previous Scores</h4>
          ${matches.slice(0,5).map(m=>{
            const resultClass = (m.our_result===1||m.our_result===16385)?'win':(m.our_result===4?'draw':'loss');
            return `
              <div class="h2h-match">
                <div class="h2h-score-section">
                  <img class="h2h-team-crest" src="${crestUrl(ourTeamId)}" alt="Rayo Vilkins">
                  <span class="h2h-score ${resultClass}">Rayo Vilkins ${m.our_goals} - ${m.opponent_goals} ${opponentName}</span>
                  <img class="h2h-team-crest" src="${crestUrl(opponentTeamId)}" alt="${opponentName}">
                </div>
                <div class="h2h-match-date">${fmtDate(m.match_timestamp)}</div>
              </div>
            `;
          }).join('')}
        </div>` : '<div style="text-align:center;color:var(--muted);margin-top:10px">No previous meetings found</div>'}
    `;
  }

  /* -------------------- NEW MATCH RENDERING -------------------- */
  function buildMatchResult(match) {
    const container = document.createElement('div');
    container.className = 'match-result';
    container.addEventListener('click', () => openModal(match.match_id));

    const ourGoals = parseInt(match.our_goals) || 0;
    const oppGoals = parseInt(match.opponent_goals) || 0;
    
    let scoreClass = '';
    if (match.result === 'W') scoreClass = 'win';
    else if (match.result === 'L') scoreClass = 'loss';
    else scoreClass = 'draw';

    container.innerHTML = `
      <div class="ft-indicator">FT</div>
      <div class="match-content">
        <div class="team-section home">
          <span class="team-name">${match.our_club_name || 'Rayo Vilkins'}</span>
          <img class="team-crest" src="${crestUrl(match.our_team_id || 480)}" alt="" onerror="this.className='team-crest placeholder'">
        </div>
        
        <div class="score-section ${scoreClass}">
          <span>${ourGoals}</span>
          <span class="score-separator">-</span>
          <span>${oppGoals}</span>
        </div>
        
        <div class="team-section away">
          <img class="team-crest" src="${crestUrl(match.opponent_team_id || 1)}" alt="" onerror="this.className='team-crest placeholder'">
          <span class="team-name">${match.opponent_club_name || 'Unknown'}</span>
        </div>
      </div>
    `;

    // Add match date
    const dateDiv = document.createElement('div');
    dateDiv.className = 'match-date';
    dateDiv.textContent = fmtDate(match.match_timestamp);
    container.appendChild(dateDiv);

    return container;
  }

  /* -------------------- MATCH LIST (pagination with match type separation) -------------------- */
  let filteredMatches = [];
  let currentPage = 1;
  const pageSize = 7;

  function getMatchTypeName(matchType) {
    switch(matchType) {
      case 1: return 'League Matches';
      case 3: return 'Playoff Matches'; 
      case 9: return 'Cup Matches';
      default: return 'Friendly Matches';
    }
  }

  function renderSummary(matches) {
    const stats = {
      played: matches.length,
      wins: matches.filter(m=>m.result==='W').length,
      draws: matches.filter(m=>m.result==='D').length,
      losses: matches.filter(m=>m.result==='L').length,
      gf: matches.reduce((s,m)=>s+(parseInt(m.our_goals)||0),0),
      ga: matches.reduce((s,m)=>s+(parseInt(m.opponent_goals)||0),0),
    };
    const box = el.summary;
    box.innerHTML = '';
    const card = (label,val,cls='') =>
      h('div',{class:'summary-card'},
        h('div',{class:'summary-label'},label),
        h('div',{class:`summary-value${cls?` ${cls}`:''}`},val)
      );
    box.appendChild(card('Played',stats.played));
    box.appendChild(card('Won',stats.wins,'win'));
    box.appendChild(card('Drawn',stats.draws,'draw'));
    box.appendChild(card('Lost',stats.losses,'loss'));
    box.appendChild(card('Goals For',stats.gf));
    box.appendChild(card('Goals Against',stats.ga));
    box.style.display = 'grid';
  }

  function groupMatchesByType(matches) {
    const groups = {};
    matches.forEach(match => {
      const type = match.match_type;
      if (!groups[type]) groups[type] = [];
      groups[type].push(match);
    });
    return Object.entries(groups)
      .sort(([a], [b]) => parseInt(b) - parseInt(a))
      .map(([type, matches]) => ({ type: parseInt(type), matches }));
  }

  function renderMatches() {
    if (!filteredMatches.length) {
      el.boards.innerHTML = '<div class="info">No matches found</div>';
      return;
    }

    const totalPages = Math.ceil(filteredMatches.length / pageSize);
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageMatches = filteredMatches.slice(startIdx, endIdx);

    const groups = groupMatchesByType(pageMatches);
    el.boards.innerHTML = groups.map(group => {
      const typeName = getMatchTypeName(group.type);
      const matchElements = group.matches.map(buildMatchResult);
      return `
        <div class="board-section">
          <div class="board-title">${typeName} (${group.matches.length})</div>
          <div class="matches-list">${matchElements.map(el => el.outerHTML).join('')}</div>
        </div>
      `;
    }).join('') + `
      <div class="pager">
        <button onclick="changePage(-1)" ${currentPage <= 1 ? 'disabled' : ''}>Previous</button>
        <span>Page ${currentPage} of ${totalPages}</span>
        <button onclick="changePage(1)" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
        <div class="info">Showing ${startIdx + 1}-${Math.min(endIdx, filteredMatches.length)} of ${filteredMatches.length} matches</div>
      </div>
    `;

    // Re-add event listeners to new elements
    document.querySelectorAll('.match-result').forEach(matchEl => {
      const matchId = pageMatches.find(m => matchEl.outerHTML.includes(m.match_id))?.match_id;
      if (matchId) {
        matchEl.addEventListener('click', () => openModal(matchId));
      }
    });
  }

  window.changePage = function(delta) {
    const totalPages = Math.ceil(filteredMatches.length / pageSize);
    currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
    renderMatches();
  };

  function applyFilters() {
    const fromDate = el.from.value;
    const toDate = el.to.value;
    const searchTerm = el.search.value.toLowerCase().trim();

    let matches = allMatches;

    if (fromDate || toDate) {
      const fromUnix = fromDate ? startUnix(fromDate) : 0;
      const toUnix = toDate ? endUnix(toDate) : Infinity;
      matches = matches.filter(m => m.match_timestamp >= fromUnix && m.match_timestamp <= toUnix);
    }

    if (searchTerm) {
      matches = matches.filter(m => 
        (m.opponent_club_name || '').toLowerCase().includes(searchTerm)
      );
    }

    filteredMatches = matches;
    currentPage = 1;
    renderSummary(filteredMatches);
    renderMatches();
  }

  function resetFilters() {
    const defaults = defaultDates();
    el.from.value = defaults.from;
    el.to.value = defaults.to;
    el.search.value = '';
    applyFilters();
  }

  el.apply.addEventListener('click', applyFilters);
  el.reset.addEventListener('click', resetFilters);

  let allMatches = [];

  async function loadMatches() {
    try {
      el.status.textContent = 'Loading matches…';
      const response = await getJSON('api/matches/all.json');
      
      if (!response.success || !response.matches) {
        throw new Error('Invalid response format');
      }

      allMatches = response.matches;
      resetFilters();
      el.status.style.display = 'none';
    } catch (error) {
      console.error('Error loading matches:', error);
      el.status.innerHTML = '<div class="error">Failed to load matches. Please try refreshing the page.</div>';
    }
  }

  loadMatches();
})();
</script>
</body>
</html>
