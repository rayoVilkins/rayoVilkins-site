<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rayo Vilkins - Stats</title>
<style>
  :root{
    --bg:#0f0f0f; --card:#1a1a1a; --text:#ffffff; --muted:#a1a1aa; --line:#333333;
    --rail:#facc15; --rail-dark:#f59e0b; --active-bg:#1e40af; --active-br:#3b82f6; --active-tx:#ffffff;
    --score:#ffffff; --win:#22c55e; --loss:#ef4444; --draw:#f59e0b;
    --navy:#ffffff; --pitch:#1a2e1a;
    --match-bg:#1f1f1f; --match-hover:#2a2a2a; --ft-bg:#333333;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body::after{content:"";display:block;height:140px}

  /* Header / Nav */
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line)}
  .bar{max-width:1500px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 14px}
  .brand{font-weight:800;letter-spacing:.2px;font-size:14px;opacity:.9;color:var(--text)}
  .brand a{color:inherit;text-decoration:none}
  nav{display:flex;gap:6px}
  nav a{color:var(--muted);text-decoration:none;font-size:13px;padding:6px 10px;border-radius:8px;border:1px solid transparent}
  nav a[aria-current="page"]{background:var(--active-bg);border-color:var(--active-br);color:var(--active-tx)}
  nav a:hover{color:var(--text)}
  .spacer{flex:1}

  /* Page */
  .wrap{max-width:1200px;margin:16px auto 120px;padding:0 14px}

  .position-filters{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0 24px;justify-content:center}
  .filter-btn{background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
  .filter-btn:hover{background:var(--match-hover);border-color:var(--rail)}
  .filter-btn.active{background:var(--rail);color:#111827;border-color:var(--rail-dark);font-weight:600}

  .stats-info{text-align:center;margin-bottom:20px;font-size:14px;color:var(--muted)}

  .stats-section{
    margin-bottom:32px;
  }
  
  .section-title{
    font-size:18px;
    font-weight:700;
    color:var(--text);
    margin-bottom:12px;
    padding-left:4px;
    border-left:4px solid var(--rail);
    padding-left:12px;
  }

  .players-grid{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    box-shadow:0 4px 20px rgba(0,0,0,.3);
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    margin-bottom:24px;
  }

  .players-table{
    width:100%;
    border-collapse:collapse;
    min-width:600px;
  }

  .players-table th{
    background:#0a0a0a;
    color:var(--text);
    padding:16px 12px;
    text-align:left;
    font-weight:600;
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:0.5px;
    border-bottom:1px solid var(--line);
    white-space:nowrap;
    user-select:none;
  }

  .players-table th:first-child{padding-left:20px;width:40px}
  .players-table th.player-name{width:200px}
  .players-table th.position{width:80px;text-align:center}
  .players-table th.rating{width:90px;text-align:center}
  .players-table th.stat{width:110px;text-align:center}

  .players-table td{
    padding:14px 12px;
    border-bottom:1px solid var(--line);
    font-size:14px;
    white-space:nowrap;
  }

  .players-table td:first-child{padding-left:20px;font-weight:600;color:var(--muted);font-size:16px}
  .players-table tr:hover{background:var(--match-hover)}
  .players-table tr:last-child td{border-bottom:none}

  .player-name-cell{font-weight:600;color:var(--text)}

  .position-badge{
    display:inline-block;padding:4px 8px;border-radius:4px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;text-align:center;
  }
  .position-ST{background:#fee2e2;color:#dc2626}
  .position-AM{background:#dbeafe;color:#2563eb}
  .position-DM{background:#f3e8ff;color:#7c3aed}
  .position-DF{background:#ecfdf5;color:#059669}
  .position-GK{background:#fef3c7;color:#d97706}

  .rating-cell{font-weight:700;font-size:16px;text-align:center}
  .rating-excellent{color:var(--win)}
  .rating-good{color:#3b82f6}
  .rating-average{color:var(--draw)}
  .rating-poor{color:var(--loss)}

  .stat-cell{text-align:center;font-weight:500;color:var(--text)}
  .games-cell{color:var(--muted);font-size:13px}

  /* Sorting UI */
  .sortable{cursor:pointer}
  .sort-wrap{display:inline-flex;align-items:center;gap:6px}
  .sort-arrow{font-size:12px;opacity:.85;color:var(--muted)}
  .sorted-asc .sort-arrow::after{content:"▲";color:var(--rail)}
  .sorted-desc .sort-arrow::after{content:"▼";color:var(--rail)}

  .empty,.error{text-align:center;padding:40px 20px;border-radius:10px;background:var(--card);border:1px dashed var(--line);margin-top:20px;font-size:14px;color:var(--muted)}
  .error{border-color:#ef4444;background:#1f1113;color:#fca5a5}
  .loading{text-align:center;padding:40px;font-size:14px;color:var(--muted)}

  @media (max-width: 768px){
    .wrap{max-width:100%;padding:0 8px}
    .players-table th, .players-table td{padding:10px 8px;font-size:12px}
    .players-table th:first-child, .players-table td:first-child{padding-left:12px}
    .players-table th.player-name{width:150px}
    .filter-btn{padding:8px 16px;font-size:13px}
    .position-filters{gap:6px}
  }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><a href="home.html">Rayo Vilkins FC</a></div>
      <div class="spacer"></div>
      <nav>
        <a href="matches.html">Matches</a>
        <a href="stats.html" aria-current="page">Stats</a>
        <a href="wheel.html">Wheel</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <div class="position-filters">
      <button class="filter-btn active" data-position="all">All</button>
      <button class="filter-btn" data-position="ST">Strikers (ST)</button>
      <button class="filter-btn" data-position="AM">Attacking Mid (AM)</button>
      <button class="filter-btn" data-position="DM">Defensive Mid (DM)</button>
      <button class="filter-btn" data-position="DF">Defenders (DF)</button>
      <button class="filter-btn" data-position="GK">Goalkeepers (GK)</button>
    </div>

    <div id="statsInfo" class="stats-info">Loading player statistics...</div>

    <div id="statsContainer">
      <div class="loading">Loading player rankings...</div>
    </div>
  </div>

<script>
(function(){
  const API_BASE = '';
  
  const filterButtons = document.querySelectorAll('.filter-btn');
  const statsInfo = document.getElementById('statsInfo');
  const statsContainer = document.getElementById('statsContainer');

  // sorting state - now per section
  let currentPosition = 'all';
  let currentPlayers = [];
  let sectionSorts = {}; // track sort state per section

  // Define stat categories
  const STAT_CATEGORIES = {
    general: {
      title: 'General',
      stats: [
        { key: 'matches_played', label: 'Games', type: 'number' },
        { key: 'wins', label: 'Wins', type: 'number' },
        { key: 'win_rate', label: 'Win%', type: 'number' },
        { key: 'motm_awards', label: 'MOTM', type: 'number' },
        { key: 'motm_rate', label: 'MOTM%', type: 'number' }
      ]
    },
    goalScoring: {
      title: 'Goal Scoring',
      stats: [
        { key: 'total_goals', label: 'Goals', type: 'number' },
        { key: 'goals_per_match', label: 'G/Game', type: 'number' },
        { key: 'shot_success_rate', label: 'Shot%', type: 'number' },
        { key: 'shots_per_match', label: 'Shots/Game', type: 'number' },
        { key: 'total_shots', label: 'Shots', type: 'number' }
      ]
    },
    creativity: {
      title: 'Creativity',
      stats: [
        { key: 'total_assists', label: 'Assists', type: 'number' },
        { key: 'assists_per_match', label: 'A/Game', type: 'number' },
        { key: 'pass_success_rate', label: 'Pass%', type: 'number' },
        { key: 'passes_made_per_match', label: 'Passes/Game', type: 'number' },
        { key: 'total_passes_made', label: 'Passes', type: 'number' },
        { key: 'goal_contributions_per_match', label: 'G+A/Game', type: 'number' },
        { key: 'goal_contributions', label: 'G+A', type: 'number' }
      ]
    },
    defending: {
      title: 'Defending',
      stats: [
        { key: 'total_tackles_made', label: 'Tackles', type: 'number' },
        { key: 'tackles_made_per_match', label: 'Tkl/Game', type: 'number' },
        { key: 'tackle_success_rate', label: 'Tackle%', type: 'number' },
        { key: 'red_cards', label: 'Reds', type: 'number' },
        { key: 'red_cards_rate', label: 'Reds%', type: 'number' }
      ]
    },
    goalkeeping: {
      title: 'Goalkeeping',
      stats: [
        { key: 'total_saves', label: 'GK Saves', type: 'number' },
        { key: 'clean_sheets_gk', label: 'GK CS', type: 'number' },
        { key: 'gk_clean_sheets_rate', label: 'GK CS%', type: 'number' }
      ]
    }
  };

  // Position-specific category visibility
  function getVisibleCategories(position) {
    const categories = ['general'];
    
    if (position === 'all') {
      return ['general', 'goalScoring', 'creativity', 'defending', 'goalkeeping'];
    } else if (position === 'GK') {
      categories.push('creativity', 'goalkeeping');
    } else if (position === 'DF') {
      categories.push('creativity', 'defending');
    } else if (position === 'DM') {
      categories.push('goalScoring', 'creativity', 'defending');
    } else if (position === 'AM' || position === 'ST') {
      categories.push('goalScoring', 'creativity');
    }
    
    return categories;
  }

  // UI helpers
  function getPositionClass(position) {
    if (!position) return 'position-DF';
    if (position === 'ST') return 'position-ST';
    if (position === 'AM') return 'position-AM';
    if (position === 'DM') return 'position-DM';
    if (['RB', 'LB', 'CB', 'DF'].includes(position)) return 'position-DF';
    if (position === 'GK') return 'position-GK';
    return 'position-DF';
  }

  function getPositionDisplay(position) {
    if (!position) return 'DF';
    if (['RB', 'LB', 'CB'].includes(position)) return 'DF';
    return position;
  }

  function getRatingClass(rating) {
    const r = Number(rating||0);
    if (r >= 8.5) return 'rating-excellent';
    if (r >= 7.5) return 'rating-good';
    if (r >= 6.5) return 'rating-average';
    return 'rating-poor';
  }

  function formatStat(value, key) {
    if (value === null || value === undefined) return '—';
    const n = Number(value);
    if (['win_rate','motm_rate','pass_success_rate','tackle_success_rate','shot_success_rate','def_clean_sheets_rate','gk_clean_sheets_rate','red_cards_rate'].includes(key)) {
      return Number.isFinite(n) ? n.toFixed(1) + '%' : value + '%';
    }
    if (['_per_match'].some(s => key.includes(s))) {
      return Number.isFinite(n) ? n.toFixed(1) : value;
    }
    return Number.isFinite(n) ? (key==='avg_rating' ? n.toFixed(1) : Math.trunc(n)) : value;
  }

  function sortPlayers(data, key, dir, type) {
    const mult = dir === 'asc' ? 1 : -1;
    const cmpNum = (a,b) => {
      const va = Number(a[key] ?? -Infinity);
      const vb = Number(b[key] ?? -Infinity);
      return (va - vb) * mult;
    };
    const cmpStr = (a,b) => {
      const va = String(a[key] ?? '');
      const vb = String(b[key] ?? '');
      return va.localeCompare(vb) * mult;
    };
    return data.slice().sort((type === 'string') ? cmpStr : cmpNum);
  }

  function buildSectionTable(sectionId, category, players, position) {
    const showPositionCol = position === 'all';
    
    // Get current sort state for this section
    const currentSort = sectionSorts[sectionId] || { key: 'avg_rating', dir: 'desc' };
    
    // Sort players according to current sort state
    const sorted = sortPlayers(players, currentSort.key, currentSort.dir, 
                              (currentSort.key === 'player_name' || currentSort.key === 'assigned_position') ? 'string' : 'number');

    const container = document.createElement('div');
    container.className = 'stats-section';
    
    const title = document.createElement('h3');
    title.className = 'section-title';
    title.textContent = category.title;
    container.appendChild(title);

    const grid = document.createElement('div');
    grid.className = 'players-grid';

    const table = document.createElement('table');
    table.className = 'players-table';

    // Build header
    const header = document.createElement('thead');
    const headerRow = document.createElement('tr');

    function createTh(label, cls, sortKey = null, type = 'number') {
      const th = document.createElement('th');
      th.className = cls + (sortKey ? ' sortable' : '');
      
      if (sortKey) {
        th.dataset.sortKey = sortKey;
        th.dataset.sortType = type;
        th.dataset.sectionId = sectionId;
        
        const wrap = document.createElement('span');
        wrap.className = 'sort-wrap';
        const text = document.createElement('span');
        text.textContent = label;
        const arrow = document.createElement('span');
        arrow.className = 'sort-arrow';
        wrap.appendChild(text);
        wrap.appendChild(arrow);
        th.appendChild(wrap);

        if (currentSort.key === sortKey) {
          th.classList.add(currentSort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      } else {
        th.textContent = label;
      }
      return th;
    }

    headerRow.appendChild(createTh('#', ''));
    headerRow.appendChild(createTh('Player', 'player-name', 'player_name', 'string'));
    if (showPositionCol) headerRow.appendChild(createTh('Pos', 'position', 'assigned_position', 'string'));
    headerRow.appendChild(createTh('Rating', 'rating', 'avg_rating', 'number'));

    category.stats.forEach(stat => {
      headerRow.appendChild(createTh(stat.label, 'stat', stat.key, stat.type));
    });

    header.appendChild(headerRow);
    table.appendChild(header);

    // Build body
    const body = document.createElement('tbody');
    sorted.forEach((player, index) => {
      const ratingVal = Number(player.avg_rating || 0);
      const ratingClass = getRatingClass(ratingVal);
      const positionClass = getPositionClass(player.assigned_position);
      const positionDisplay = getPositionDisplay(player.assigned_position);

      const row = document.createElement('tr');

      // # column
      const idxCell = document.createElement('td');
      idxCell.textContent = index + 1;
      row.appendChild(idxCell);

      // Player name
      const nameCell = document.createElement('td');
      nameCell.className = 'player-name-cell';
      nameCell.textContent = player.player_name || 'Unknown';
      row.appendChild(nameCell);

      // Position (only for 'all' filter)
      if (showPositionCol) {
        const posCell = document.createElement('td');
        posCell.innerHTML = `<span class="position-badge ${positionClass}">${positionDisplay}</span>`;
        row.appendChild(posCell);
      }

      // Rating
      const ratingCell = document.createElement('td');
      ratingCell.className = `rating-cell ${ratingClass}`;
      ratingCell.textContent = ratingVal.toFixed(1);
      row.appendChild(ratingCell);

      // Stats
      category.stats.forEach(stat => {
        const statCell = document.createElement('td');
        statCell.className = 'stat-cell';
        statCell.textContent = formatStat(player[stat.key], stat.key);
        row.appendChild(statCell);
      });

      body.appendChild(row);
    });

    table.appendChild(body);
    grid.appendChild(table);
    container.appendChild(grid);

    return container;
  }

  function attachSortHandlers() {
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.sortKey;
        const type = th.dataset.sortType || 'number';
        const sectionId = th.dataset.sectionId;
        
        if (!key || !sectionId) return;

        // Update sort state for this section
        const currentSort = sectionSorts[sectionId] || { key: 'avg_rating', dir: 'desc' };
        
        if (currentSort.key === key) {
          currentSort.dir = (currentSort.dir === 'asc') ? 'desc' : 'asc';
        } else {
          currentSort.key = key;
          currentSort.dir = (type === 'string') ? 'asc' : 'desc';
        }
        
        sectionSorts[sectionId] = currentSort;
        
        // Re-render all tables
        renderAllTables();
      });
    });
  }

  function renderAllTables() {
    if (!currentPlayers.length) return;

    statsContainer.innerHTML = '';
    
    const visibleCategories = getVisibleCategories(currentPosition);
    
    visibleCategories.forEach(categoryId => {
      const category = STAT_CATEGORIES[categoryId];
      if (!category) return;
      
      const sectionTable = buildSectionTable(categoryId, category, currentPlayers, currentPosition);
      statsContainer.appendChild(sectionTable);
    });

    attachSortHandlers();
  }

  async function getJSON(path) {
    const res = await fetch(`${API_BASE}${path}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function loadPlayerRankings(position = 'all') {
    try {
      statsContainer.innerHTML = '<div class="loading">Loading player rankings...</div>';

      const suffix = position === 'all' ? 'all' : position.toUpperCase();
      const response = await getJSON(`api/players/rankings_${suffix}.json`);
      currentPlayers = response.players || [];
      currentPosition = position;

      // Reset sort states for new position
      sectionSorts = {};

      const positionText = position === 'all' ? 'All' : 
                          position === 'ST' ? 'Strikers' :
                          position === 'AM' ? 'Attacking Midfielders' :
                          position === 'DM' ? 'Defensive Midfielders' :
                          position === 'DF' ? 'Defenders (RB, LB, CB)' :
                          position === 'GK' ? 'Goalkeepers' : 'Players';

      statsInfo.textContent = `Showing ${currentPlayers.length} ${positionText}`;

      if (currentPlayers.length === 0) {
        statsContainer.innerHTML = '<div class="empty">No players found for this position</div>';
        return;
      }

      renderAllTables();
    } catch (error) {
      console.error('Error loading player rankings:', error);
      statsContainer.innerHTML = `<div class="error">Could not load player rankings – ${error.message}</div>`;
    }
  }

  // Filter button events
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadPlayerRankings(btn.dataset.position);
    });
  });

  // Initial load
  loadPlayerRankings('all');
})();
</script>
</body>
</html>
